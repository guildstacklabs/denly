@page "/vault"
@using Denly.Models
@using Denly.Services
@inject IDocumentService DocumentService

<div class="vault-page">
    <!-- Header -->
    <div class="page-header">
        <h1>Family Vault</h1>
        <button class="add-btn" @onclick="OpenAddDocumentModal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add
        </button>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text"
               class="search-input"
               placeholder="Search documents..."
               @bind="SearchTerm"
               @bind:event="oninput"
               @onkeyup="OnSearchChanged" />
        @if (!string.IsNullOrEmpty(SearchTerm))
        {
            <button class="clear-search" @onclick="ClearSearch">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        }
    </div>

    <!-- Folder Filter -->
    <div class="folder-tabs">
        <button class="folder-tab @(SelectedFolder == null ? "active" : "")"
                @onclick="() => SelectFolder(null)">
            All
            <span class="tab-count">@_documents.Count</span>
        </button>
        @foreach (DocumentFolder folder in Enum.GetValues<DocumentFolder>())
        {
            var count = _folderCounts.GetValueOrDefault(folder, 0);
            <button class="folder-tab @(SelectedFolder == folder ? "active" : "")"
                    style="--folder-color: @folder.GetColor()"
                    @onclick="() => SelectFolder(folder)">
                @folder.GetDisplayName()
                @if (count > 0)
                {
                    <span class="tab-count">@count</span>
                }
            </button>
        }
    </div>

    <!-- Documents List -->
    @if (_isLoading)
    {
        <LoadingSpinner Message="Loading documents..." Size="LoadingSize.Large" />
    }
    else
    {
    <div class="documents-section">
        @if (_filteredDocuments.Any())
        {
            @if (string.IsNullOrEmpty(SearchTerm) && SelectedFolder == null)
            {
                <!-- Grouped by folder -->
                @foreach (var group in _filteredDocuments.GroupBy(d => d.Folder))
                {
                    <div class="folder-group">
                        <div class="folder-header" style="--folder-color: @group.Key.GetColor()">
                            <div class="folder-color-dot"></div>
                            <h2>@group.Key.GetDisplayName()</h2>
                            <span class="folder-count">@group.Count()</span>
                        </div>
                        <div class="documents-list">
                            @foreach (var doc in group)
                            {
                                <div class="document-card" @onclick="() => OpenViewDocumentModal(doc)">
                                    <div class="document-icon" style="background-color: @doc.Folder.GetColor()20; color: @doc.Folder.GetColor()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                        </svg>
                                    </div>
                                    <div class="document-content">
                                        <div class="document-name">@doc.Title</div>
                                        @if (!string.IsNullOrEmpty(doc.FileName))
                                        {
                                            <div class="document-file">@doc.FileName</div>
                                        }
                                    </div>
                                    <svg class="document-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Flat list for search/filter results -->
                <div class="documents-list">
                    @foreach (var doc in _filteredDocuments)
                    {
                        <div class="document-card" @onclick="() => OpenViewDocumentModal(doc)">
                            <div class="document-icon" style="background-color: @doc.Folder.GetColor()20; color: @doc.Folder.GetColor()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                            </div>
                            <div class="document-content">
                                <div class="document-name">@doc.Title</div>
                                <div class="document-meta">
                                    <span class="document-folder" style="color: @doc.Folder.GetColor()">@doc.Folder.GetDisplayName()</span>
                                    @if (!string.IsNullOrEmpty(doc.FileName))
                                    {
                                        <span class="document-file">@doc.FileName</span>
                                    }
                                </div>
                            </div>
                            <svg class="document-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            <div class="no-documents">
                @if (!string.IsNullOrEmpty(SearchTerm))
                {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <p>No documents found for "@SearchTerm"</p>
                }
                else if (SelectedFolder != null)
                {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                    </svg>
                    <p>No @SelectedFolder.Value.GetDisplayName().ToLower() documents yet</p>
                }
                else
                {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    <p>Your vault is empty</p>
                    <span class="empty-hint">Keep important family documents safe here</span>
                }
                <button class="add-document-link" @onclick="OpenAddDocumentModal">Add your first document</button>
            </div>
        }
    </div>
    } @* end else !_isLoading *@
</div>

<!-- View/Edit Document Modal -->
@if (ShowViewModal && ViewingDocument != null)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@ViewingDocument.Title</h3>
                <button class="close-btn" @onclick="CloseModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body view-mode">
                <div class="detail-row">
                    <span class="detail-label">Folder</span>
                    <span class="detail-value folder-badge" style="--folder-color: @ViewingDocument.Folder.GetColor()">
                        @ViewingDocument.Folder.GetDisplayName()
                    </span>
                </div>

                @if (!string.IsNullOrEmpty(ViewingDocument.FileName))
                {
                    <div class="detail-row">
                        <span class="detail-label">File</span>
                        <span class="detail-value file-name">@ViewingDocument.FileName</span>
                    </div>
                }

                <div class="detail-row">
                    <span class="detail-label">Added</span>
                    <span class="detail-value">@ViewingDocument.CreatedAt.ToLocalTime().ToString("MMM d, yyyy")</span>
                </div>
            </div>

            <div class="modal-footer">
                <button class="delete-btn" @onclick="ShowDeleteConfirmation">Delete</button>
                <button class="edit-btn" @onclick="OpenEditDocumentModal">Edit</button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (ShowDeleteModal)
{
    <div class="modal-overlay" @onclick="CancelDelete">
        <div class="modal-content confirm-modal" @onclick:stopPropagation="true">
            <div class="confirm-icon delete-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </div>
            <h3 class="confirm-title">Delete this document?</h3>
            <p class="confirm-text">This can't be undone.</p>
            <div class="confirm-actions">
                <button class="cancel-btn" @onclick="CancelDelete">Cancel</button>
                <button class="delete-confirm-btn" @onclick="ConfirmDelete">Delete</button>
            </div>
        </div>
    </div>
}

<!-- Source Picker Modal -->
@if (ShowSourcePicker)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content source-picker-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Add Document</h3>
                <button class="close-btn" @onclick="CloseModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="source-options">
                    <button class="source-option" @onclick="TakePhoto">
                        <div class="source-icon camera">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                        </div>
                        <div class="source-text">
                            <span class="source-title">Camera</span>
                            <span class="source-desc">Take a photo</span>
                        </div>
                    </button>

                    <button class="source-option" @onclick="PickFromGallery">
                        <div class="source-icon gallery">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </div>
                        <div class="source-text">
                            <span class="source-title">Photo Gallery</span>
                            <span class="source-desc">Choose existing photo</span>
                        </div>
                    </button>

                    <button class="source-option" @onclick="PickFromFiles">
                        <div class="source-icon files">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                        </div>
                        <div class="source-text">
                            <span class="source-title">Files</span>
                            <span class="source-desc">Browse device files</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add/Edit Document Modal -->
@if (ShowEditModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(IsEditing ? "Edit Document" : "New Document")</h3>
                <button class="close-btn" @onclick="CloseModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                @if (!string.IsNullOrEmpty(_pendingFilePath) || !string.IsNullOrEmpty(EditingDocument.FileUrl))
                {
                    <div class="file-preview-section">
                        @if (IsImageFile(_pendingFileName ?? EditingDocument.FileName))
                        {
                            <div class="image-preview">
                                <img src="@(_pendingFilePath ?? EditingDocument.FileUrl)" alt="Preview" />
                            </div>
                        }
                        else
                        {
                            <div class="file-preview">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                <span>@(_pendingFileName ?? EditingDocument.FileName)</span>
                            </div>
                        }
                        <button class="change-file-btn" @onclick="ChangeFile">Change</button>
                    </div>
                }

                <div class="form-group">
                    <label>Document Name</label>
                    <input type="text" @bind="EditingDocument.Title" placeholder="e.g., Birth Certificate, Insurance Card" />
                </div>

                <div class="form-group">
                    <label>Folder</label>
                    <div class="folder-selector">
                        @foreach (DocumentFolder folder in Enum.GetValues<DocumentFolder>())
                        {
                            <button class="folder-btn @(EditingDocument.Folder == folder ? "selected" : "")"
                                    style="--folder-color: @folder.GetColor()"
                                    @onclick="() => EditingDocument.Folder = folder">
                                @folder.GetDisplayName()
                            </button>
                        }
                    </div>
                </div>

                @if (!IsEditing && string.IsNullOrEmpty(_pendingFilePath))
                {
                    <div class="form-group">
                        <label>File (optional)</label>
                        <div class="file-input-wrapper">
                            <button class="file-select-btn" @onclick="OpenSourcePicker">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Attach File
                            </button>
                        </div>
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="cancel-btn" @onclick="CloseModal">Cancel</button>
                <button class="save-btn" @onclick="SaveDocument" disabled="@(!IsValidDocument)">
                    @(IsEditing ? "Save" : "Add Document")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<Document> _documents = new();
    private List<Document> _filteredDocuments = new();
    private Dictionary<DocumentFolder, int> _folderCounts = new();

    private bool _isLoading = true;

    private string SearchTerm = string.Empty;
    private DocumentFolder? SelectedFolder;

    private bool ShowViewModal;
    private bool ShowEditModal;
    private bool ShowSourcePicker;
    private bool ShowDeleteModal;
    private bool IsEditing;
    private Document? ViewingDocument;
    private Document EditingDocument = new();

    // Temporary file info before upload
    private string? _pendingFilePath;
    private string? _pendingFileName;

    private bool IsValidDocument => !string.IsNullOrWhiteSpace(EditingDocument.Title);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadData();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadData()
    {
        _documents = await DocumentService.GetAllDocumentsAsync();
        _folderCounts = await DocumentService.GetFolderCountsAsync();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var filtered = _documents.AsEnumerable();

        if (SelectedFolder != null)
        {
            filtered = filtered.Where(d => d.Folder == SelectedFolder);
        }

        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            var term = SearchTerm.ToLowerInvariant();
            filtered = filtered.Where(d =>
                d.Title.ToLowerInvariant().Contains(term) ||
                (d.FileName?.ToLowerInvariant().Contains(term) ?? false));
        }

        _filteredDocuments = filtered.ToList();
    }

    private void SelectFolder(DocumentFolder? folder)
    {
        SelectedFolder = folder;
        ApplyFilters();
    }

    private void OnSearchChanged()
    {
        ApplyFilters();
    }

    private void ClearSearch()
    {
        SearchTerm = string.Empty;
        ApplyFilters();
    }

    private void OpenAddDocumentModal()
    {
        IsEditing = false;
        EditingDocument = new Document
        {
            Folder = SelectedFolder ?? DocumentFolder.Other
        };
        _pendingFilePath = null;
        _pendingFileName = null;
        ShowViewModal = false;
        ShowEditModal = false;
        ShowSourcePicker = true;
    }

    private void OpenSourcePicker()
    {
        ShowEditModal = false;
        ShowSourcePicker = true;
    }

    private void ShowEditModalWithFile()
    {
        ShowSourcePicker = false;
        ShowEditModal = true;
    }

    private void OpenViewDocumentModal(Document doc)
    {
        ViewingDocument = doc;
        ShowEditModal = false;
        ShowViewModal = true;
    }

    private void OpenEditDocumentModal()
    {
        if (ViewingDocument == null) return;

        IsEditing = true;
        EditingDocument = new Document
        {
            Id = ViewingDocument.Id,
            Title = ViewingDocument.Title,
            Folder = ViewingDocument.Folder,
            FileUrl = ViewingDocument.FileUrl,
            ChildId = ViewingDocument.ChildId,
            CreatedAt = ViewingDocument.CreatedAt
        };
        _pendingFilePath = null;
        _pendingFileName = null;
        ShowViewModal = false;
        ShowEditModal = true;
    }

    private void CloseModal()
    {
        ShowViewModal = false;
        ShowEditModal = false;
        ShowSourcePicker = false;
        ViewingDocument = null;
        EditingDocument = new Document();
        _pendingFilePath = null;
        _pendingFileName = null;
    }

    private async Task SaveDocument()
    {
        if (!IsValidDocument)
            return;

        // If there's a pending file, we need to upload it
        // For now, we'll set the FileUrl to the local path
        // In production, this would upload to Supabase Storage
        if (!string.IsNullOrEmpty(_pendingFilePath))
        {
            EditingDocument.FileUrl = _pendingFilePath;
        }

        await DocumentService.SaveDocumentAsync(EditingDocument);
        CloseModal();
        await LoadData();
    }

    private void ShowDeleteConfirmation()
    {
        ShowViewModal = false;
        ShowDeleteModal = true;
    }

    private void CancelDelete()
    {
        ShowDeleteModal = false;
        ShowViewModal = true;
    }

    private async Task ConfirmDelete()
    {
        if (ViewingDocument == null) return;

        await DocumentService.DeleteDocumentAsync(ViewingDocument.Id);
        ShowDeleteModal = false;
        CloseModal();
        await LoadData();
    }

    private async Task TakePhoto()
    {
        try
        {
            if (!MediaPicker.Default.IsCaptureSupported)
                return;

            var photo = await MediaPicker.Default.CapturePhotoAsync();
            if (photo != null)
            {
                _pendingFilePath = photo.FullPath;
                _pendingFileName = photo.FileName;
                ShowEditModalWithFile();
            }
        }
        catch
        {
            // Camera not available or user cancelled
        }
    }

    private async Task PickFromGallery()
    {
        try
        {
            var photo = await MediaPicker.Default.PickPhotoAsync();
            if (photo != null)
            {
                _pendingFilePath = photo.FullPath;
                _pendingFileName = photo.FileName;
                ShowEditModalWithFile();
            }
        }
        catch
        {
            // Gallery not available or user cancelled
        }
    }

    private async Task PickFromFiles()
    {
        try
        {
            var result = await FilePicker.Default.PickAsync(new PickOptions
            {
                PickerTitle = "Select a document"
            });

            if (result != null)
            {
                _pendingFilePath = result.FullPath;
                _pendingFileName = result.FileName;
                ShowEditModalWithFile();
            }
        }
        catch
        {
            // User cancelled or error occurred
        }
    }

    private void ChangeFile()
    {
        ShowEditModal = false;
        ShowSourcePicker = true;
    }

    private bool IsImageFile(string? fileName)
    {
        if (string.IsNullOrEmpty(fileName))
            return false;

        var extension = Path.GetExtension(fileName).ToLowerInvariant();
        return extension is ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" or ".webp" or ".heic";
    }
}
