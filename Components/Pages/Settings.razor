@page "/settings"
@using Denly.Models
@using Denly.Services
@using Microsoft.Extensions.Logging
@inject IDenService DenService
@inject IChildService ChildService
@inject IInviteService InviteService
@inject IAuthService Auth
@inject NavigationManager Navigation
@inject ILogger<Settings> Logger

<div class="settings-page">
    <div class="page-header">
        <button class="back-btn" @onclick="GoBack">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <h1>Settings</h1>
    </div>

    @if (_isLoading)
    {
        <LoadingSpinner Message="Loading settings..." />
    }
    else if (_currentDen != null)
    {
        <!-- Den Section -->
        <Nook Title="Your Den" CssClass="settings-nook">
            <div class="den-card">
                <div class="den-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </div>
                <div class="den-info">
                    <span class="den-name">@_currentDen.Name</span>
                    <span class="den-role">@(_isOwner ? "Owner" : "Co-parent")</span>
                </div>
            </div>
        </Nook>

        <!-- Members Section -->
        <Nook CssClass="settings-nook">
            <div class="section-header">
                <h2 class="section-title">
                    Members
                    @if (_members.Count == 1 && _isOwner)
                    {
                        <span class="notification-dot" aria-hidden="true"></span>
                    }
                </h2>
                @if (_isOwner)
                {
                    <button class="invite-btn" @onclick="OpenInviteModal">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        Invite
                    </button>
                }
            </div>

            <div class="members-list">
                @foreach (var member in _members)
                {
                    <div class="member-card">
                        <div class="member-avatar">
                            @(GetInitials(member.DisplayName ?? member.Email ?? "?"))
                        </div>
                        <div class="member-info">
                            <span class="member-name">@(member.DisplayName ?? member.Email ?? "Member")</span>
                            <span class="member-role">@(member.IsOwner ? "Owner" : "Co-parent")</span>
                        </div>
                        @if (_isOwner && !member.IsOwner)
                        {
                            <button class="remove-member-btn" @onclick="() => ConfirmRemoveMember(member)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        }
                    </div>
                }

                @if (_members.Count == 1 && _isOwner)
                {
                    <div class="invite-prompt">
                        <p>Invite your co-parent to start coordinating together</p>
                        <button class="invite-prompt-btn" @onclick="OpenInviteModal">
                            Send Invite
                        </button>
                    </div>
                }
            </div>
        </Nook>

        <!-- Children Section -->
        <div class="settings-section">
            <div class="section-header">
                <h2 class="section-title">Children</h2>
                <button class="invite-btn" @onclick="OpenAddChildModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add
                </button>
            </div>

            @if (_activeChildren.Count == 0)
            {
                <div class="empty-children">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <p>No children added yet</p>
                    <button class="add-child-prompt-btn" @onclick="OpenAddChildModal">Add Your First Child</button>
                </div>
            }
            else
            {
                <div class="children-list">
                    @foreach (var child in _activeChildren)
                    {
                        var displayName = ChildService.GetDisplayName(child, _activeChildren);
                        <div class="child-card">
                            <div class="child-avatar" style="@(child.Color != null ? $"background-color: {child.Color}" : "")">
                                @(displayName.Length > 0 ? displayName[0].ToString().ToUpperInvariant() : "?")
                            </div>
                            <div class="child-info">
                                <span class="child-name">@child.FullName</span>
                                @if (child.Age.HasValue)
                                {
                                    <span class="child-age">@child.Age years old</span>
                                }
                            </div>
                            <div class="child-actions">
                                <button class="edit-child-btn" @onclick="() => OpenEditChildModal(child)" title="Edit">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="deactivate-child-btn" @onclick="() => ConfirmDeactivateChild(child)" title="Deactivate">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }

            @if (_deactivatedChildren.Count > 0)
            {
                <div class="inactive-section">
                    <button class="inactive-toggle" @onclick="ToggleInactiveSection">
                        <svg class="@(_showInactiveChildren ? "expanded" : "")" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        Inactive (@_deactivatedChildren.Count)
                    </button>

                    @if (_showInactiveChildren)
                    {
                        <div class="inactive-children-list">
                            @foreach (var child in _deactivatedChildren)
                            {
                                <div class="child-card inactive">
                                    <div class="child-avatar inactive-avatar">
                                        @(child.FirstName.Length > 0 ? child.FirstName[0].ToString().ToUpperInvariant() : "?")
                                    </div>
                                    <div class="child-info">
                                        <span class="child-name">@child.FullName</span>
                                        <span class="child-status">Deactivated</span>
                                    </div>
                                    <button class="reactivate-btn" @onclick="() => ConfirmReactivateChild(child)" title="Reactivate">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 2v6h-6"></path>
                                            <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                                            <path d="M3 22v-6h6"></path>
                                            <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                                        </svg>
                                        Reactivate
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Account Section -->
        <Nook Title="Account" CssClass="settings-nook">
            <div class="account-info">
                @if (_currentUser != null)
                {
                    <div class="account-email">@_currentUser.Email</div>
                }
            </div>

            <div class="settings-row">
                <div class="row-text">
                    <span class="row-title">Notifications</span>
                    <span class="row-subtitle">Coming soon</span>
                </div>
                <label class="den-toggle" aria-label="Notifications (coming soon)">
                    <input type="checkbox" disabled />
                    <span class="den-toggle-track"></span>
                </label>
            </div>
            <button class="signout-btn" @onclick="SignOut">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Sign Out
            </button>
        </Nook>
    }
    else if (!_isLoading)
    {
        <!-- No den - show account section only -->
        <Nook Title="Account" CssClass="settings-nook">
            <div class="account-info">
                @if (_currentUser != null)
                {
                    <div class="account-email">@_currentUser.Email</div>
                }
            </div>
            <div class="settings-row">
                <div class="row-text">
                    <span class="row-title">Notifications</span>
                    <span class="row-subtitle">Coming soon</span>
                </div>
                <label class="den-toggle" aria-label="Notifications (coming soon)">
                    <input type="checkbox" disabled />
                    <span class="den-toggle-track"></span>
                </label>
            </div>
            <button class="signout-btn" @onclick="SignOut">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Sign Out
            </button>
        </Nook>
    }
</div>

<!-- Invite Modal -->
@if (_showInviteModal)
{
    <div class="modal-overlay" @onclick="CloseInviteModal">
        <div class="modal-content invite-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Invite Co-Parent</h3>
                <button class="close-btn" @onclick="CloseInviteModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                @if (_isLoadingInvite)
                {
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <span>Generating code...</span>
                    </div>
                }
                else if (_activeInvite != null)
                {
                    <p class="invite-instruction">Share this code with your co-parent:</p>

                    <div class="invite-code-display">
                        <span class="invite-code">@FormatCode(_activeInvite.Code)</span>
                    </div>

                    <div class="invite-actions">
                        <button class="action-btn copy-btn" @onclick="CopyCode">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copy Code
                        </button>
                        <button class="action-btn share-btn" @onclick="ShareCode">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"></circle>
                                <circle cx="6" cy="12" r="3"></circle>
                                <circle cx="18" cy="19" r="3"></circle>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg>
                            Share
                        </button>
                    </div>

                    <div class="invite-expiry">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span>Expires in @FormatTimeRemaining(_activeInvite.TimeRemaining)</span>
                    </div>

                    <button class="generate-new-btn" @onclick="GenerateNewCode">
                        Generate New Code
                    </button>
                }
            </div>
        </div>
    </div>
}

<!-- Remove Member Confirmation Modal -->
@if (_showRemoveModal && _memberToRemove != null)
{
    <div class="modal-overlay" @onclick="CancelRemove">
        <div class="modal-content confirm-modal" @onclick:stopPropagation="true">
            <div class="confirm-icon warning-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="18" y1="8" x2="23" y2="13"></line>
                    <line x1="23" y1="8" x2="18" y2="13"></line>
                </svg>
            </div>
            <h3 class="confirm-title">Remove member?</h3>
            <p class="confirm-text">@(_memberToRemove.DisplayName ?? _memberToRemove.Email ?? "This member") will no longer have access to your den.</p>
            <div class="confirm-actions">
                <button class="cancel-btn" @onclick="CancelRemove">Cancel</button>
                <button class="delete-confirm-btn" @onclick="RemoveMember">Remove</button>
            </div>
        </div>
    </div>
}

<!-- Add/Edit Child Modal -->
@if (_showChildModal)
{
    <AddEditChildModal Child="_childToEdit"
                       OnSave="HandleSaveChild"
                       OnCancel="CloseChildModal"
                       ValidateNameAsync="ChildService.ValidateChildNameAsync" />
}

<!-- Deactivate Child Confirmation Modal -->
@if (_showDeactivateModal && _childToDeactivate != null)
{
    <div class="modal-overlay" @onclick="CancelDeactivateChild">
        <div class="modal-content confirm-modal" @onclick:stopPropagation="true">
            <div class="confirm-icon warning-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                </svg>
            </div>
            <h3 class="confirm-title">Deactivate @_childToDeactivate.FirstName?</h3>
            <p class="confirm-text">This will hide @_childToDeactivate.FirstName from all selectors. Historical records will be preserved.</p>
            <div class="confirm-actions">
                <button class="cancel-btn" @onclick="CancelDeactivateChild">Cancel</button>
                <button class="delete-confirm-btn" @onclick="DeactivateChild">Deactivate</button>
            </div>
        </div>
    </div>
}

<!-- Reactivate Child Confirmation Modal -->
@if (_showReactivateModal && _childToReactivate != null)
{
    <div class="modal-overlay" @onclick="CancelReactivateChild">
        <div class="modal-content confirm-modal" @onclick:stopPropagation="true">
            <div class="confirm-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 2v6h-6"></path>
                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                    <path d="M3 22v-6h6"></path>
                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                </svg>
            </div>
            <h3 class="confirm-title">Reactivate @_childToReactivate.FirstName?</h3>
            <p class="confirm-text">@_childToReactivate.FirstName will be visible again in all selectors.</p>
            <div class="confirm-actions">
                <button class="cancel-btn" @onclick="CancelReactivateChild">Cancel</button>
                <button class="btn-primary" @onclick="ReactivateChild">Reactivate</button>
            </div>
        </div>
    </div>
}

@code {
    private Den? _currentDen;
    private AppUser? _currentUser;
    private List<DenMember> _members = new();
    private bool _isOwner;
    private bool _isLoading = true;
    private bool _showInviteModal;
    private bool _showRemoveModal;
    private bool _isLoadingInvite;
    private DenInvite? _activeInvite;
    private DenMember? _memberToRemove;

    // Children state
    private List<Child> _activeChildren = new();
    private List<Child> _deactivatedChildren = new();
    private bool _showChildModal;
    private bool _showDeactivateModal;
    private bool _showReactivateModal;
    private bool _showInactiveChildren;
    private Child? _childToEdit;
    private Child? _childToDeactivate;
    private Child? _childToReactivate;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;

        // Load user and den in parallel
        var userTask = Auth.GetCurrentUserAsync();
        var denTask = DenService.GetCurrentDenAsync();

        await Task.WhenAll(userTask, denTask);

        _currentUser = await userTask;
        _currentDen = await denTask;

        if (_currentDen != null)
        {
            // Load members, owner status, and children in parallel
            var membersTask = DenService.GetDenMembersAsync();
            var ownerTask = DenService.IsOwnerAsync();
            var childrenTask = ChildService.GetAllChildrenAsync();

            await Task.WhenAll(membersTask, ownerTask, childrenTask);

            _members = await membersTask;
            _isOwner = await ownerTask;

            var allChildren = await childrenTask;
            _activeChildren = allChildren.Where(c => c.IsActive).ToList();
            _deactivatedChildren = allChildren.Where(c => !c.IsActive).ToList();
        }

        _isLoading = false;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private async Task OpenInviteModal()
    {
        if (_currentDen == null) return;

        _showInviteModal = true;
        _isLoadingInvite = true;
        StateHasChanged();

        // Check for existing active invite
        _activeInvite = await InviteService.GetActiveInviteAsync(_currentDen.Id);

        if (_activeInvite == null && _currentUser != null)
        {
            // Generate new invite
            _activeInvite = await InviteService.CreateInviteAsync(_currentDen.Id, _currentUser.Id);
        }

        _isLoadingInvite = false;
    }

    private void CloseInviteModal()
    {
        _showInviteModal = false;
        _activeInvite = null;
    }

    private async Task GenerateNewCode()
    {
        if (_currentDen == null || _currentUser == null) return;

        _isLoadingInvite = true;
        StateHasChanged();

        // Delete existing invite if any
        if (_activeInvite != null)
        {
            await InviteService.DeleteInviteAsync(_activeInvite.Id);
        }

        // Create new invite
        _activeInvite = await InviteService.CreateInviteAsync(_currentDen.Id, _currentUser.Id);
        _isLoadingInvite = false;
    }

    private async Task CopyCode()
    {
        if (_activeInvite == null) return;

        try
        {
            await Clipboard.Default.SetTextAsync(_activeInvite.Code);
            Logger.LogDebug("Code copied to clipboard");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to copy code to clipboard");
        }
    }

    private async Task ShareCode()
    {
        if (_activeInvite == null || _currentDen == null) return;

        try
        {
            var shareText = $"Join me on Denly to coordinate our family!\n\n" +
                           $"1. Download Denly from the App Store\n" +
                           $"2. Sign up and choose \"Join a Den\"\n" +
                           $"3. Enter code: {_activeInvite.Code}\n\n" +
                           $"This code expires in {FormatTimeRemaining(_activeInvite.TimeRemaining)}.";

            await Share.Default.RequestAsync(new ShareTextRequest
            {
                Text = shareText,
                Title = $"Join {_currentDen.Name} on Denly"
            });
        }
        catch
        {
            // User cancelled or sharing not available
        }
    }

    private void ConfirmRemoveMember(DenMember member)
    {
        _memberToRemove = member;
        _showRemoveModal = true;
    }

    private void CancelRemove()
    {
        _showRemoveModal = false;
        _memberToRemove = null;
    }

    private async Task RemoveMember()
    {
        if (_memberToRemove == null || _currentDen == null) return;

        try
        {
            await DenService.RemoveMemberAsync(_currentDen.Id, _memberToRemove.UserId);
            Logger.LogInformation("Member removed successfully");
            _showRemoveModal = false;
            _memberToRemove = null;
            await LoadData();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to remove member");
        }
    }

    private async Task SignOut()
    {
        await Auth.SignOutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpperInvariant();

        return name.Length >= 2 ? name.Substring(0, 2).ToUpperInvariant() : name.ToUpperInvariant();
    }

    private string FormatCode(string code)
    {
        if (code.Length <= 4) return code;
        return $"{code.Substring(0, 4)} {code.Substring(4)}";
    }

    private string FormatTimeRemaining(TimeSpan remaining)
    {
        if (remaining.TotalDays >= 1)
        {
            int days = (int)remaining.TotalDays;
            return $"{days} day{(days != 1 ? "s" : "")}";
        }
        if (remaining.TotalHours >= 1)
        {
            int hours = (int)remaining.TotalHours;
            return $"{hours} hour{(hours != 1 ? "s" : "")}";
        }
        if (remaining.TotalMinutes >= 1)
        {
            int minutes = (int)remaining.TotalMinutes;
            return $"{minutes} minute{(minutes != 1 ? "s" : "")}";
        }
        return "less than a minute";
    }

    // Child management methods
    private void OpenAddChildModal()
    {
        _childToEdit = null;
        _showChildModal = true;
    }

    private void OpenEditChildModal(Child child)
    {
        _childToEdit = child;
        _showChildModal = true;
    }

    private void CloseChildModal()
    {
        _showChildModal = false;
        _childToEdit = null;
    }

    private async Task HandleSaveChild(Child child)
    {
        try
        {
            if (_childToEdit != null)
            {
                // Update existing child
                child.Id = _childToEdit.Id;
                child.DenId = _childToEdit.DenId;
                await ChildService.UpdateChildAsync(child);
                Logger.LogInformation("Child updated successfully");
            }
            else
            {
                // Add new child
                await ChildService.AddChildAsync(child);
                Logger.LogInformation("Child added successfully");
            }

            _showChildModal = false;
            _childToEdit = null;
            await LoadData();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save child");
        }
    }

    private void ConfirmDeactivateChild(Child child)
    {
        _childToDeactivate = child;
        _showDeactivateModal = true;
    }

    private void CancelDeactivateChild()
    {
        _showDeactivateModal = false;
        _childToDeactivate = null;
    }

    private async Task DeactivateChild()
    {
        if (_childToDeactivate == null) return;

        try
        {
            await ChildService.DeactivateChildAsync(_childToDeactivate.Id);
            Logger.LogInformation("Child deactivated successfully");
            _showDeactivateModal = false;
            _childToDeactivate = null;
            await LoadData();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to deactivate child");
        }
    }

    private void ConfirmReactivateChild(Child child)
    {
        _childToReactivate = child;
        _showReactivateModal = true;
    }

    private void CancelReactivateChild()
    {
        _showReactivateModal = false;
        _childToReactivate = null;
    }

    private async Task ReactivateChild()
    {
        if (_childToReactivate == null) return;

        try
        {
            await ChildService.ReactivateChildAsync(_childToReactivate.Id);
            Logger.LogInformation("Child reactivated successfully");
            _showReactivateModal = false;
            _childToReactivate = null;
            await LoadData();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to reactivate child");
        }
    }

    private void ToggleInactiveSection()
    {
        _showInactiveChildren = !_showInactiveChildren;
    }
}
