@page "/"
@using Denly.Models
@using Denly.Services
@using Denly.Components.Shared
@using Microsoft.Extensions.Logging
@inject IScheduleService ScheduleService
@inject IExpenseService ExpenseService
@inject IDocumentService DocumentService
@inject IDenTimeService DenTimeService
@inject NavigationManager Navigation
@inject IAuthService AuthService
@inject ILogger<Home> Logger

<div class="home-sanctuary">
    <div class="sanctuary-content">
        <div class="home-hero">
            <div class="hero-title">
                <span>@_heroTitleLine1</span>
                <span>@_heroTitleLine2</span>
            </div>
        </div>

        <div class="hero-modules">
            <div class="hero-module">
                <div class="hero-label">Child cards strip</div>
                <div class="child-cards">
                    @foreach (var child in _heroChildren)
                    {
                        <div class="child-card">
                            <div class="child-name">@child.Name</div>
                            <div class="child-dots">
                                @foreach (var dot in child.UpcomingDots)
                                {
                                    <span class="child-dot @(dot ? "active" : "")"></span>
                                }
                            </div>
                            <div class="child-next">@child.NextItem</div>
                        </div>
                    }
                </div>
            </div>

            <div class="hero-module">
                <div class="hero-label">Child hero • Variant A</div>
                <div class="child-hero-grid">
                    @foreach (var child in _heroChildren)
                    {
                        <div class="child-hero-card">
                            <div class="child-hero-top">
                                <span class="child-hero-initials">@child.Initials</span>
                                <span class="child-hero-name">@child.Name</span>
                            </div>
                            <div class="child-hero-next">@child.NextItem</div>
                            <div class="child-hero-meta">
                                <span>@child.UpcomingCount upcoming</span>
                                <span>@(child.HasNext ? "Today" : "Soon")</span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            
            <div class="hero-module">
                <div class="hero-label">Expenses tile • Variant A</div>
                <div class="expense-tile expense-tile--summary">
                    <div class="expense-tile__header">
                        <div class="expense-tile__title">@_expenseTileA.Title</div>
                        <div class="expense-tile__period">@_expenseTileA.Period</div>
                    </div>
                    <div class="expense-tile__amount">@_expenseTileA.Total</div>
                    <div class="expense-tile__meta">
                        <span>@_expenseTileA.PaidStatus</span>
                        <span>•</span>
                        <span>@_expenseTileA.NextDue</span>
                    </div>
                </div>
            </div>

            <div class="hero-module">
                <div class="hero-label">Expenses tile • Variant B</div>
                <div class="expense-tile expense-tile--cards">
                    <div class="expense-tile__stack">
                        <div class="expense-pill">
                            <span class="expense-pill__label">@_expenseTileB.TopLabel</span>
                            <span class="expense-pill__value">@_expenseTileB.TopValue</span>
                        </div>
                        <div class="expense-pill">
                            <span class="expense-pill__label">@_expenseTileB.BottomLabel</span>
                            <span class="expense-pill__value">@_expenseTileB.BottomValue</span>
                        </div>
                    </div>
                    <div class="expense-tile__footer">
                        <span>@_expenseTileB.FooterLeft</span>
                        <span>@_expenseTileB.FooterRight</span>
                    </div>
                </div>
            </div>

            <div class="hero-module">
                <div class="hero-label">Expenses tile • Variant C</div>
                <div class="expense-tile expense-tile--list">
                    <div class="expense-tile__header">
                        <div class="expense-tile__title">@_expenseTileC.Title</div>
                        <div class="expense-tile__period">@_expenseTileC.Period</div>
                    </div>
                    <div class="expense-row">
                        <span class="expense-row__title">@_expenseTileC.Row1Title</span>
                        <span class="expense-row__amount">@_expenseTileC.Row1Amount</span>
                    </div>
                    <div class="expense-row">
                        <span class="expense-row__title">@_expenseTileC.Row2Title</span>
                        <span class="expense-row__amount">@_expenseTileC.Row2Amount</span>
                    </div>
                    <div class="expense-tile__footer">
                        <span>@_expenseTileC.FooterLeft</span>
                        <span>@_expenseTileC.FooterRight</span>
                    </div>
                </div>
            </div>

            <div class="hero-module">
                <div class="hero-label">Expenses tile • Variant D</div>
                <div class="expense-tile expense-tile--split">
                    <div class="expense-tile__header">
                        <div class="expense-tile__title">@_expenseTileD.Title</div>
                        <div class="expense-tile__period">@_expenseTileD.Period</div>
                    </div>
                    <div class="expense-split">
                        <div class="expense-split__card">
                            <span class="expense-split__label">@_expenseTileD.LeftLabel</span>
                            <span class="expense-split__value">@_expenseTileD.LeftValue</span>
                        </div>
                        <div class="expense-split__card">
                            <span class="expense-split__label">@_expenseTileD.RightLabel</span>
                            <span class="expense-split__value">@_expenseTileD.RightValue</span>
                        </div>
                    </div>
                    <div class="expense-tile__footer">
                        <span>@_expenseTileD.FooterLeft</span>
                        <span>@_expenseTileD.FooterRight</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- 4-Day Schedule Spine -->
        <div class="schedule-spine">
            @if (_isLoading)
            {
                <LoadingSpinner Message="Opening your den..." Size="LoadingSize.Large" />
            }
            else
            {
                @foreach (var day in _scheduleDays)
                {
                    <DayCard DayName="@day.DayName" 
                             DateText="@day.DateText" 
                             OverflowCount="@day.OverflowCount">
                        @if (day.Events.Any())
                        {
                            @for (int idx = 0; idx < Math.Min(3, day.Events.Count); idx++)
                            {
                                var evt = day.Events[idx];
                                <div class="sanctuary-event-row" @onclick="() => NavigateToEvent(evt)">
                                    <div class="event-time">@FormatEventTime(evt)</div>
                                    <div class="event-details">
                                        <span class="event-title">@evt.Title</span>
                                        @if (!string.IsNullOrEmpty(evt.Location))
                                        {
                                            <span class="event-location">@evt.Location</span>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-day-hint">No items</div>
                        }
                    </DayCard>
                }
            }
        </div>

        <div class="spacer-bottom"></div>
    </div>
</div>

<style>
    .home-sanctuary {
        padding-bottom: 80px; /* Space for bottom nav */
        min-height: 100vh;
        background-color: var(--color-background);
    }

    .sanctuary-content {
        padding: 1rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .home-hero {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .hero-title {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
        font-size: 2rem;
        font-weight: 600;
        color: var(--color-text);
        letter-spacing: -0.02em;
    }

    .hero-modules {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .hero-module {
        background: var(--color-surface-glass);
        border: 1px solid var(--color-border-soft);
        border-radius: 16px;
        padding: 0.75rem;
        box-shadow: var(--shadow-pebble);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .hero-label {
        font-size: 0.8rem;
        color: var(--color-text-subtle);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 0.5rem;
    }

    .child-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
    }

    .child-card {
        background: var(--color-surface-glass-10);
        border: 1px solid var(--color-border-soft);
        border-radius: 12px;
        padding: 0.5rem 0.6rem;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .child-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--color-text);
    }

    .child-dots {
        display: flex;
        gap: 0.25rem;
    }

    .child-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--color-border-soft);
    }

    .child-dot.active {
        background: var(--color-text-muted);
    }

    .child-next {
        font-size: 0.8rem;
        color: var(--color-text-muted);
    }

    .child-hero-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.5rem;
    }

    .child-hero-card {
        background: var(--color-surface-glass-10);
        border: 1px solid var(--color-border-soft);
        border-radius: 14px;
        padding: 0.6rem;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .child-hero-top {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .child-hero-initials {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--color-surface-glass);
        border: 1px solid var(--color-border-soft);
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--color-text);
    }

    .child-hero-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--color-text);
    }

    .child-hero-next {
        font-size: 0.85rem;
        color: var(--color-text-muted);
    }

    .child-hero-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--color-text-subtle);
    }

    .expense-tile {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        padding: 0.75rem;
        border-radius: 14px;
        background: var(--color-surface-glass-10);
        border: 1px solid var(--color-border-soft);
    }

    .expense-tile__header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 0.75rem;
    }

    .expense-tile__title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text);
    }

    .expense-tile__period {
        font-size: 0.8rem;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    .expense-tile__amount {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--color-text);
        letter-spacing: -0.02em;
    }

    .expense-tile__meta,
    .expense-tile__footer {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: var(--color-text-muted);
    }

    .expense-tile__stack {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .expense-pill {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.45rem 0.6rem;
        border-radius: 999px;
        background: var(--color-surface-glass);
        border: 1px solid var(--color-border-soft);
        font-size: 0.85rem;
    }

    .expense-pill__label {
        color: var(--color-text-muted);
    }

    .expense-pill__value {
        color: var(--color-text);
        font-weight: 600;
    }

    .expense-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.35rem 0;
        border-bottom: 1px solid var(--color-border-soft);
        font-size: 0.9rem;
    }

    .expense-row:last-of-type {
        border-bottom: none;
    }

    .expense-row__title {
        color: var(--color-text);
        font-weight: 500;
    }

    .expense-row__amount {
        color: var(--color-text-muted);
    }

    .expense-split {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.5rem;
    }

    .expense-split__card {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        padding: 0.5rem 0.6rem;
        border-radius: 12px;
        background: var(--color-surface-glass);
        border: 1px solid var(--color-border-soft);
    }

    .expense-split__label {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    .expense-split__value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--color-text);
    }


    .schedule-spine {
        display: flex;
        flex-direction: column;
        gap: 0; /* Cards have margin-bottom */
    }

    .sanctuary-event-row {
        display: flex;
        gap: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 14px;
        background: var(--color-surface-glass-10);
        border: 1px solid var(--color-border-soft);
        cursor: pointer;
        margin-bottom: 0.5rem;
    }
    
    .sanctuary-event-row:last-child {
        margin-bottom: 0;
    }


    .event-time {
        font-size: 0.875rem;
        color: var(--color-text-muted);
        width: 4.5rem;
        flex-shrink: 0;
        text-align: right;
    }

    .event-details {
        display: flex;
        flex-direction: column;
    }

    .event-title {
        font-size: 0.9375rem;
        color: var(--color-text);
        font-weight: 500;
    }
    
    .event-location {
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    .empty-day-hint {
        font-size: 0.875rem;
        color: var(--color-text-subtle);
        font-style: italic;
        padding: 0.5rem 0;
    }

    .spacer-bottom {
        height: 40px;
    }
</style>

@code {
    private bool _isLoading = true;
    private List<DaySchedule> _scheduleDays = new();
    private decimal _totalOwed = 0;
    private TimeZoneInfo? _denTimeZone;
    private string _heroTitleLine1 = "Coming";
    private string _heroTitleLine2 = "Up";

    private readonly List<HeroChild> _heroChildren = new()
    {
        new HeroChild("Avery", "AV", "8:00 AM • School pickup", new [] { true, true, false }, 2, true),
        new HeroChild("Jamie", "JM", "4:30 PM • Soccer", new [] { true, false, true }, 1, false),
        new HeroChild("Rowan", "RW", "6:00 PM • Dinner", new [] { false, true, true }, 3, false)
    };

    // Real expense data
    private decimal _monthTotal = 0;
    private decimal _userBalance = 0;  // Positive = owed to user, Negative = user owes
    private decimal _userShare = 0;
    private List<Expense> _recentExpenses = new();

    // Computed expense tiles from real data
    private ExpenseTileMock _expenseTileA => new(
        "Den expenses",
        "This month",
        _monthTotal.ToString("C"),
        _userBalance >= 0 ? $"You're owed {Math.Abs(_userBalance):C}" : $"You owe {Math.Abs(_userBalance):C}",
        "");

    private ExpenseTileStackMock _expenseTileB => new(
        "Shared total",
        _monthTotal.ToString("C"),
        "Your share",
        _userShare.ToString("C"),
        _recentExpenses.FirstOrDefault()?.Description ?? "No expenses",
        "Split 50/50");

    private ExpenseTileListMock _expenseTileC => new(
        "Recent expenses",
        "Last 7 days",
        _recentExpenses.ElementAtOrDefault(0)?.Description ?? "—",
        _recentExpenses.ElementAtOrDefault(0)?.Amount.ToString("C") ?? "",
        _recentExpenses.ElementAtOrDefault(1)?.Description ?? "—",
        _recentExpenses.ElementAtOrDefault(1)?.Amount.ToString("C") ?? "",
        _recentExpenses.Count > 2 ? $"{_recentExpenses.Count - 2} more" : "",
        "View all");

    private ExpenseTileSplitMock _expenseTileD => new(
        "Split snapshot",
        "This month",
        "Total",
        _monthTotal.ToString("C"),
        "Your share",
        _userShare.ToString("C"),
        _userBalance != 0 ? (_userBalance >= 0 ? $"Owed {Math.Abs(_userBalance):C}" : $"Unsettled {Math.Abs(_userBalance):C}") : "Settled",
        "Auto-split 50/50");


    protected override async Task OnInitializedAsync()
    {
        SetHeroTitle();
        await LoadData();
    }

    private void SetHeroTitle()
    {
        var phrases = new[]
        {
            ("Coming", "Up"),
            ("Next", "Few Days"),
            ("On the", "Agenda"),
            ("In", "View"),
            ("What's", "Next")
        };

        var pick = phrases[new Random().Next(phrases.Length)];
        _heroTitleLine1 = pick.Item1;
        _heroTitleLine2 = pick.Item2;
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _denTimeZone = await DenTimeService.GetDenTimeZoneAsync();
            var today = _denTimeZone == null
                ? DateTime.Today
                : DenTimeService.ConvertToDenTime(DateTime.UtcNow, _denTimeZone).Date;

            // Load schedule and expense data in parallel
            var endDate = today.AddDays(2);
            var eventsTask = ScheduleService.GetEventsByRangeAsync(today, endDate);
            var expensesTask = ExpenseService.GetExpensesAsync();
            var balancesTask = ExpenseService.GetBalancesAsync();
            var userTask = AuthService.GetCurrentUserAsync();

            await Task.WhenAll(eventsTask, expensesTask, balancesTask, userTask);

            var events = await eventsTask;
            var expenses = await expensesTask;
            var balances = await balancesTask;
            var currentUser = await userTask;

            // Build schedule days
            _scheduleDays.Clear();
            for (int i = 0; i < 3; i++)
            {
                var date = today.AddDays(i);
                var dayEvents = events.Where(e =>
                    (_denTimeZone == null ? e.Date.Date : DenTimeService.ConvertToDenTime(e.StartsAt, _denTimeZone).Date) == date
                ).OrderBy(e => e.StartsAt).ToList();

                _scheduleDays.Add(new DaySchedule
                {
                    Date = date,
                    DayName = i == 0 ? "Today" : (i == 1 ? "Tomorrow" : date.ToString("dddd")),
                    DateText = date.ToString("MMM d"),
                    Events = dayEvents,
                    OverflowCount = Math.Max(0, dayEvents.Count - 3)
                });
            }

            // Calculate expense totals
            var startOfMonth = new DateTime(today.Year, today.Month, 1);
            var monthExpenses = expenses.Where(e => e.CreatedAt >= startOfMonth && !e.IsSettled).ToList();
            _monthTotal = monthExpenses.Sum(e => e.Amount);
            _userShare = _monthTotal / 2; // Default 50/50 split

            // Get user's balance (positive = owed to user, negative = user owes)
            if (currentUser != null && balances.TryGetValue(currentUser.Id, out var balance))
            {
                _userBalance = balance;
            }
            else
            {
                _userBalance = 0;
            }

            // Get recent expenses (last 7 days)
            var sevenDaysAgo = today.AddDays(-7);
            _recentExpenses = expenses
                .Where(e => e.CreatedAt >= sevenDaysAgo)
                .OrderByDescending(e => e.CreatedAt)
                .Take(5)
                .ToList();

            _totalOwed = Math.Abs(_userBalance);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading Home data");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string FormatEventTime(Event evt)
    {
        if (evt.AllDay) return "All Day";
        if (evt.Time.HasValue)
        {
             var time = DateTime.Today.Add(evt.Time.Value);
             return time.ToString("h:mm tt");
        }
        return "";
    }

    private void NavigateToEvent(Event evt)
    {
        // For now, navigate to calendar, ideally jump to date
        // Simple implementation:
        Navigation.NavigateTo("/calendar");
    }

    private class DaySchedule
    {
        public DateTime Date { get; set; }
        public string DayName { get; set; } = "";
        public string DateText { get; set; } = "";
        public List<Event> Events { get; set; } = new();
        public int OverflowCount { get; set; }
    }

    public record HeroChild(
        string Name,
        string Initials,
        string NextItem,
        IReadOnlyList<bool> UpcomingDots,
        int UpcomingCount,
        bool HasNext);

    public record ExpenseTileMock(
        string Title,
        string Period,
        string Total,
        string PaidStatus,
        string NextDue);

    public record ExpenseTileStackMock(
        string TopLabel,
        string TopValue,
        string BottomLabel,
        string BottomValue,
        string FooterLeft,
        string FooterRight);

    public record ExpenseTileListMock(
        string Title,
        string Period,
        string Row1Title,
        string Row1Amount,
        string Row2Title,
        string Row2Amount,
        string FooterLeft,
        string FooterRight);

    public record ExpenseTileSplitMock(
        string Title,
        string Period,
        string LeftLabel,
        string LeftValue,
        string RightLabel,
        string RightValue,
        string FooterLeft,
        string FooterRight);

}
