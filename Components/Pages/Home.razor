@page "/"
@using Denly.Models
@using Denly.Services
@using Denly.Components.Shared
@using Microsoft.Extensions.Logging
@inject IScheduleService ScheduleService
@inject IExpenseService ExpenseService
@inject IDocumentService DocumentService
@inject IDenTimeService DenTimeService
@inject NavigationManager Navigation
@inject ILogger<Home> Logger

<div class="home-sanctuary">
    <SanctuaryHeader Title="Today" 
                    Subtitle="@_lastUpdatedText" 
                    IsCollapsed="@_isHeaderCollapsed" />

    <div class="sanctuary-content">
        <!-- 4-Day Schedule Spine -->
        <div class="schedule-spine">
            @if (_isLoading)
            {
                <LoadingSpinner Message="Opening your den..." Size="LoadingSize.Large" />
            }
            else
            {
                @foreach (var day in _scheduleDays)
                {
                    <DayCard DayName="@day.DayName" 
                             DateText="@day.DateText" 
                             OverflowCount="@day.OverflowCount">
                        @if (day.Events.Any())
                        {
                            @foreach (var evt in day.Events.Take(3))
                            {
                                <div class="sanctuary-event-row" @onclick="() => NavigateToEvent(evt)">
                                    <div class="event-time">@FormatEventTime(evt)</div>
                                    <div class="event-details">
                                        <span class="event-title">@evt.Title</span>
                                        @if (!string.IsNullOrEmpty(evt.Location))
                                        {
                                            <span class="event-location">@evt.Location</span>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-day-hint">No items</div>
                        }
                    </DayCard>
                }
            }
        </div>

        <!-- Life Snapshot Cards -->
        @if (!_isLoading)
        {
            <div class="snapshot-widgets">
                <CompactCostsCard OnClick="@(() => Navigation.NavigateTo("/costs"))">
                    <div class="cost-summary">
                        @if (_totalOwed == 0)
                        {
                            <div class="cost-settled">Nothing to settle</div>
                        }
                        else
                        {
                            <div class="cost-balance">@_totalOwed.ToString("C")</div>
                            <div class="cost-label">Outstanding</div>
                        }
                    </div>
                </CompactCostsCard>

                <ChildInfoCard OnClick="@(() => Navigation.NavigateTo("/info"))">
                     <span class="chip">School</span>
                     <span class="chip">Care</span>
                     <span class="chip">Health</span>
                </ChildInfoCard>
            </div>
            
            <div class="spacer-bottom"></div>
        }
    </div>
</div>

<style>
    .home-sanctuary {
        padding-bottom: 80px; /* Space for bottom nav */
        min-height: 100vh;
        background-color: #f9f9f9; /* Soft background */
    }

    .sanctuary-content {
        padding: 1rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .schedule-spine {
        display: flex;
        flex-direction: column;
        gap: 0; /* Cards have margin-bottom */
    }

    .sanctuary-event-row {
        display: flex;
        gap: 1rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(0,0,0,0.03);
        cursor: pointer;
    }
    
    .sanctuary-event-row:last-child {
        border-bottom: none;
    }

    .event-time {
        font-size: 0.875rem;
        color: #666;
        width: 4.5rem;
        flex-shrink: 0;
        text-align: right;
    }

    .event-details {
        display: flex;
        flex-direction: column;
    }

    .event-title {
        font-size: 0.9375rem;
        color: #1a1a1a;
        font-weight: 500;
    }
    
    .event-location {
        font-size: 0.75rem;
        color: #888;
    }

    .empty-day-hint {
        font-size: 0.875rem;
        color: #aaa;
        font-style: italic;
        padding: 0.5rem 0;
    }

    .snapshot-widgets {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .cost-summary {
        text-align: center;
        padding: 0.5rem 0;
    }

    .cost-balance {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1a1a1a;
    }
    
    .cost-label {
        font-size: 0.75rem;
        color: #666;
    }
    
    .cost-settled {
        color: #666;
        font-size: 0.875rem;
    }

    .chip {
        background: #f0f0f0;
        padding: 0.25rem 0.75rem;
        border-radius: 100px;
        font-size: 0.75rem;
        color: #444;
        display: inline-block;
    }
    
    .spacer-bottom {
        height: 40px;
    }
</style>

@code {
    private bool _isLoading = true;
    private bool _isHeaderCollapsed = false;
    private string _lastUpdatedText = "Last updated a short while ago";
    private List<DaySchedule> _scheduleDays = new();
    private decimal _totalOwed = 0;
    private TimeZoneInfo? _denTimeZone;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _denTimeZone = await DenTimeService.GetDenTimeZoneAsync();
            var today = _denTimeZone == null 
                ? DateTime.Today 
                : DenTimeService.ConvertToDenTime(DateTime.UtcNow, _denTimeZone).Date;

            // Load 4 days of schedule
            var endDate = today.AddDays(3);
            // Assuming GetEventsByRangeAsync takes inclusive dates
            var events = await ScheduleService.GetEventsByRangeAsync(today, endDate);

            _scheduleDays.Clear();
            for (int i = 0; i < 4; i++)
            {
                var date = today.AddDays(i);
                var dayEvents = events.Where(e => 
                    (_denTimeZone == null ? e.Date.Date : DenTimeService.ConvertToDenTime(e.StartsAt, _denTimeZone).Date) == date
                ).OrderBy(e => e.StartsAt).ToList();

                _scheduleDays.Add(new DaySchedule
                {
                    Date = date,
                    DayName = i == 0 ? "Today" : (i == 1 ? "Tomorrow" : date.ToString("dddd")),
                    DateText = date.ToString("MMM d"),
                    Events = dayEvents,
                    OverflowCount = Math.Max(0, dayEvents.Count - 3)
                });
            }

            // Load Expenses Balance
            var balances = await ExpenseService.GetBalancesAsync();
            if (balances != null && balances.Any())
            {
                var max = balances.Values.Any() ? balances.Values.Max() : 0;
                var min = balances.Values.Any() ? balances.Values.Min() : 0;
                _totalOwed = Math.Max(Math.Abs(max), Math.Abs(min));
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading Home data");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string FormatEventTime(Event evt)
    {
        if (evt.AllDay) return "All Day";
        if (evt.Time.HasValue)
        {
             var time = DateTime.Today.Add(evt.Time.Value);
             return time.ToString("h:mm tt");
        }
        return "";
    }

    private void NavigateToEvent(Event evt)
    {
        // For now, navigate to calendar, ideally jump to date
        // Simple implementation:
        Navigation.NavigateTo("/calendar");
    }

    private class DaySchedule
    {
        public DateTime Date { get; set; }
        public string DayName { get; set; } = "";
        public string DateText { get; set; } = "";
        public List<Event> Events { get; set; } = new();
        public int OverflowCount { get; set; }
    }
}