@page "/calendar"
@using Denly.Models
@using Denly.Services
@using Denly.Components.Shared
@inject IScheduleService ScheduleService
@inject IConnectivity Connectivity

<div class="calendar-page">
    <div class="calendar-header-area">
        <button class="nav-btn" @onclick="PreviousMonth">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <h2 class="calendar-title">@CurrentDate.ToString("MMMM yyyy")</h2>
        <button class="nav-btn" @onclick="NextMonth">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid-card">
        <div class="week-days-header">
            @foreach (var day in DayNames)
            {
                <span class="week-day">@day.Substring(0, 1)</span>
            }
        </div>
        
        <div class="days-grid">
            @foreach (var day in CalendarDays)
            {
                <div class="grid-day @(day.IsCurrentMonth ? "" : "other-month") @(day.IsToday ? "today" : "") @(day.Date == SelectedDate ? "selected" : "")"
                     @onclick="() => SelectDay(day.Date)">
                    <span class="day-num">@day.Date.Day</span>
                    @if (day.Events.Any())
                    {
                        <div class="dot-indicator"></div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Agenda Below Cal -->
    <div class="agenda-container">
        <div class="agenda-header">
            <span class="agenda-date">
                @(SelectedDate.HasValue ? SelectedDate.Value.ToString("dddd, MMM d") : "Select a day")
            </span>
            <span class="agenda-date-secondary">
                @(SelectedDate.HasValue ? SelectedDate.Value.ToString("MMM d") : "")
            </span>
        </div>

        <div class="agenda-items">
            @if (SelectedDayEvents.Any())
            {
                @foreach (var evt in SelectedDayEvents)
                {
                    <div class="sanctuary-event-row">
                        <div class="event-time">@FormatEventTime(evt)</div>
                        <div class="event-details">
                            <span class="event-title">@evt.Title</span>
                            <span class="event-location">@evt.Location</span>
                        </div>
                    </div>
                }
                
                @if (SelectedDayEvents.Count > 3)
                {
                    <div class="more-items-pill">+@(SelectedDayEvents.Count - 3) more items</div>
                }
            }
            else
            {
                <div class="empty-state">No events</div>
            }
        </div>
    </div>
</div>

<style>
    .calendar-page {
        padding: 1rem 1.5rem;
        background-color: #f9f9f9;
        min-height: 100vh;
        padding-bottom: 100px;
    }

    .calendar-header-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .calendar-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0;
    }

    .nav-btn {
        background: none;
        border: none;
        padding: 8px;
        color: #666;
    }
    
    .nav-btn svg {
        width: 20px;
        height: 20px;
    }

    .calendar-grid-card {
        background: #fff; /* Plain white, clean */
        border-radius: 0; /* Or minimal radius if desired, guide says "Month view" */
        /* Let's make it look like the image: clean grid, no borders */
        margin-bottom: 2rem;
    }

    .week-days-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        margin-bottom: 0.5rem;
    }

    .week-day {
        font-size: 0.75rem;
        color: #999;
        font-weight: 500;
        padding: 0.5rem 0;
    }

    .days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        row-gap: 0.5rem;
    }

    .grid-day {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 0.9375rem;
        color: #1a1a1a;
        cursor: pointer;
        position: relative;
    }

    .grid-day.other-month {
        color: #ccc;
    }
    
    .grid-day.today {
        /* Not selected, just today */
        font-weight: 600;
    }

    .grid-day.selected {
        background-color: #333; /* Dark/Black selected state per image? Or soft grey? Image shows dark selection */
        color: #fff;
    }
    
    .dot-indicator {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background-color: #999; /* Neutral dot */
        position: absolute;
        bottom: 6px;
    }
    
    .grid-day.selected .dot-indicator {
        background-color: rgba(255,255,255,0.5);
    }
    
    /* Agenda Styles (Reused from Home roughly) */
    .agenda-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 1rem;
        padding: 0 0.5rem;
    }
    
    .agenda-date {
        font-size: 1rem;
        font-weight: 600;
        color: #1a1a1a;
    }
    
    .agenda-date-secondary {
        font-size: 0.875rem;
        color: #888;
    }
    
    .agenda-items {
        background: rgba(255,255,255,0.6);
        border-radius: 20px;
        padding: 1rem;
        backdrop-filter: blur(8px);
    }
    
    .sanctuary-event-row {
        display: flex;
        gap: 1rem;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    
    .event-time {
        font-size: 0.875rem;
        color: #666;
        width: 4.5rem;
        flex-shrink: 0;
        text-align: right;
    }

    .event-details {
        display: flex;
        flex-direction: column;
    }

    .event-title {
        font-size: 0.9375rem;
        color: #1a1a1a;
        font-weight: 500;
    }
    
    .event-location {
        font-size: 0.75rem;
        color: #888;
    }
    
    .more-items-pill {
        background: #f0f0f0;
        border-radius: 12px;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.8125rem;
        color: #666;
        margin-top: 0.5rem;
    }
    
    .empty-state {
        text-align: center;
        color: #999;
        padding: 1rem;
        font-style: italic;
    }
</style>

@code {
    private DateTime CurrentDate = DateTime.Today;
    private DateTime? SelectedDate = DateTime.Today;
    private List<CalendarDay> CalendarDays = new();
    private List<Event> MonthEvents = new();
    private List<Event> SelectedDayEvents = new();
    private static readonly string[] DayNames = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthData();
    }

    private async Task LoadMonthData()
    {
        // Simple mock or load logic
        var startDate = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        var endDate = startDate.AddMonths(1).AddDays(-1);
        
        // Assuming ScheduleService exists and works
        MonthEvents = await ScheduleService.GetEventsByRangeAsync(startDate, endDate);
        BuildCalendarDays();
        
        if (SelectedDate.HasValue)
        {
            SelectedDayEvents = MonthEvents.Where(e => e.Date.Date == SelectedDate.Value.Date).ToList();
        }
    }

    private void BuildCalendarDays()
    {
        CalendarDays.Clear();
        var firstOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        var startDate = firstOfMonth.AddDays(-(int)firstOfMonth.DayOfWeek);

        for (int i = 0; i < 42; i++) // 6 weeks
        {
            var date = startDate.AddDays(i);
            var dayEvents = MonthEvents.Where(e => e.Date.Date == date.Date).ToList();
            CalendarDays.Add(new CalendarDay
            {
                Date = date,
                IsCurrentMonth = date.Month == CurrentDate.Month,
                IsToday = date.Date == DateTime.Today,
                Events = dayEvents
            });
        }
    }

    private void SelectDay(DateTime date)
    {
        SelectedDate = date;
        SelectedDayEvents = MonthEvents.Where(e => e.Date.Date == date.Date).ToList();
        
        if (date.Month != CurrentDate.Month)
        {
            CurrentDate = new DateTime(date.Year, date.Month, 1);
            // Ideally reload month data here too
            _ = LoadMonthData();
        }
    }

    private async Task PreviousMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        await LoadMonthData();
    }

    private async Task NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        await LoadMonthData();
    }

    private string FormatEventTime(Event evt)
    {
        if (evt.AllDay) return "All day";
        if (evt.Time.HasValue)
        {
            return DateTime.Today.Add(evt.Time.Value).ToString("h:mm tt");
        }
        return "";
    }

    private class CalendarDay
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool IsToday { get; set; }
        public List<Event> Events { get; set; } = new();
    }
}