@page "/calendar"
@using Denly.Models
@using Denly.Services
@using Denly.Components.Shared
@inject IScheduleService ScheduleService
@inject IConnectivity Connectivity

<div class="calendar-page">
    <div class="calendar-header-area">
        <button class="nav-btn" @onclick="PreviousMonth">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <h2 class="calendar-title">@CurrentDate.ToString("MMMM yyyy")</h2>
        <button class="nav-btn" @onclick="NextMonth">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid-card">
        <div class="week-days-header">
            @foreach (var day in DayNames)
            {
                <span class="week-day">@day.Substring(0, 1)</span>
            }
        </div>
        
        <div class="days-grid">
            @foreach (var day in CalendarDays)
            {
                <div class="grid-day @(day.IsCurrentMonth ? "" : "other-month") @(day.IsToday ? "today" : "") @(day.Date == SelectedDate ? "selected" : "")"
                     @onclick="() => SelectDay(day.Date)">
                    <span class="day-num">@day.Date.Day</span>
                    @if (day.Events.Any())
                    {
                        <div class="dot-indicator"></div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Agenda Below Cal -->
    <div class="agenda-container">
        <div class="agenda-header">
            <span class="agenda-date">
                @(SelectedDate.HasValue ? SelectedDate.Value.ToString("dddd, MMM d") : "Select a day")
            </span>
            <span class="agenda-date-secondary">
                @(SelectedDate.HasValue ? SelectedDate.Value.ToString("MMM d") : "")
            </span>
        </div>

        <div class="agenda-items">
            @if (SelectedDayEvents.Any())
            {
                @foreach (var evt in SelectedDayEvents)
                {
                    <div class="sanctuary-event-row">
                        <div class="event-time">@FormatEventTime(evt)</div>
                        <div class="event-details">
                            <span class="event-title">@evt.Title</span>
                            <span class="event-location">@evt.Location</span>
                        </div>
                    </div>
                }
                
                @if (SelectedDayEvents.Count > 3)
                {
                    <div class="more-items-pill">+@(SelectedDayEvents.Count - 3) more items</div>
                }
            }
            else
            {
                <div class="empty-state">No events</div>
            }
        </div>
    </div>
</div>

@code {
    private DateTime CurrentDate = DateTime.Today;
    private DateTime? SelectedDate = DateTime.Today;
    private List<CalendarDay> CalendarDays = new();
    private List<Event> MonthEvents = new();
    private List<Event> SelectedDayEvents = new();
    private static readonly string[] DayNames = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthData();
    }

    private async Task LoadMonthData()
    {
        // Simple mock or load logic
        var startDate = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        var endDate = startDate.AddMonths(1).AddDays(-1);
        
        // Assuming ScheduleService exists and works
        MonthEvents = await ScheduleService.GetEventsByRangeAsync(startDate, endDate);
        BuildCalendarDays();
        
        if (SelectedDate.HasValue)
        {
            SelectedDayEvents = MonthEvents.Where(e => e.Date.Date == SelectedDate.Value.Date).ToList();
        }
    }

    private void BuildCalendarDays()
    {
        CalendarDays.Clear();
        var firstOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        var startDate = firstOfMonth.AddDays(-(int)firstOfMonth.DayOfWeek);

        for (int i = 0; i < 42; i++) // 6 weeks
        {
            var date = startDate.AddDays(i);
            var dayEvents = MonthEvents.Where(e => e.Date.Date == date.Date).ToList();
            CalendarDays.Add(new CalendarDay
            {
                Date = date,
                IsCurrentMonth = date.Month == CurrentDate.Month,
                IsToday = date.Date == DateTime.Today,
                Events = dayEvents
            });
        }
    }

    private void SelectDay(DateTime date)
    {
        SelectedDate = date;
        SelectedDayEvents = MonthEvents.Where(e => e.Date.Date == date.Date).ToList();
        
        if (date.Month != CurrentDate.Month)
        {
            CurrentDate = new DateTime(date.Year, date.Month, 1);
            // Ideally reload month data here too
            _ = LoadMonthData();
        }
    }

    private async Task PreviousMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        await LoadMonthData();
    }

    private async Task NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        await LoadMonthData();
    }

    private string FormatEventTime(Event evt)
    {
        if (evt.AllDay) return "All day";
        if (evt.Time.HasValue)
        {
            return DateTime.Today.Add(evt.Time.Value).ToString("h:mm tt");
        }
        return "";
    }

    private class CalendarDay
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool IsToday { get; set; }
        public List<Event> Events { get; set; } = new();
    }
}
