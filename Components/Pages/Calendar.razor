@page "/schedule"
@using Denly.Models
@using Denly.Services
@inject IScheduleService ScheduleService
@inject IConnectivity Connectivity
@implements IDisposable

<div class="schedule-page">
    <!-- Month Navigation -->
    <div class="month-nav">
        <button class="nav-btn" @onclick="PreviousMonth" disabled="@_isLoadingMonth">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <h2 class="month-title">@CurrentDate.ToString("MMMM yyyy")</h2>
        <button class="nav-btn" @onclick="NextMonth" disabled="@_isLoadingMonth">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>
    </div>

    @if (_isLoading)
    {
        <LoadingSpinner Message="Loading calendar..." Size="LoadingSize.Large" />
    }
    else
    {
    <!-- Calendar Grid -->
    <div class="calendar-container @(_isLoadingMonth ? "loading-overlay" : "")">
        <div class="calendar-header">
            @foreach (var day in DayNames)
            {
                <div class="day-name">@day</div>
            }
        </div>
        <div class="calendar-grid">
            @foreach (var day in CalendarDays)
            {
                <div class="calendar-day @(day.IsCurrentMonth ? "" : "other-month") @(day.IsToday ? "today" : "") @(day.Date == SelectedDate ? "selected" : "")"
                     @onclick="() => SelectDay(day.Date)">
                    <span class="day-number">@day.Date.Day</span>
                    @if (day.Events.Any())
                    {
                        <div class="event-dots">
                            @foreach (var evt in day.Events.Take(3))
                            {
                                <span class="event-dot" style="background-color: @evt.Type.GetColor()"></span>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Selected Day Events -->
    @if (SelectedDate.HasValue)
    {
        <div class="day-events">
            <div class="day-events-header">
                <h3>@SelectedDate.Value.ToString("dddd, MMM d")</h3>
                <button class="add-btn" @onclick="OpenAddEventModal" disabled="@(!_isOnline)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add
                </button>
            </div>

            @if (SelectedDayEvents.Any())
            {
                <div class="events-list">
                    @foreach (var evt in SelectedDayEvents)
                    {
                        <div class="event-card" @onclick="() => OpenEditEventModal(evt)">
                            <div class="event-color-bar" style="background-color: @evt.Type.GetColor()"></div>
                            <div class="event-content">
                                <div class="event-title">@evt.Title</div>
                                <div class="event-meta">
                                    <span class="event-type">@evt.Type.GetDisplayName()</span>
                                    @if (evt.Time.HasValue)
                                    {
                                        <span class="event-time">@FormatTime(evt.Time.Value)</span>
                                    }
                                </div>
                            </div>
                            <svg class="event-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="no-events">
                    <p>No events scheduled for this day</p>
                    <span class="empty-hint">Tap + to add your first one</span>
                </div>
            }
        </div>
    }
    } @* end else !_isLoading *@
</div>

<!-- Event Modal -->
@if (ShowEventModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(IsEditing ? "Edit Event" : "New Event")</h3>
                <button class="close-btn" @onclick="CloseModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" @bind="EditingEvent.Title" placeholder="Event title" />
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" @bind="EditingEventDate" />
                </div>

                <div class="form-group">
                    <label>Time (optional)</label>
                    <div class="time-picker-native @(ShowTimeError ? "time-picker-error" : "")">
                        <div class="time-picker-wheel">
                            <select @bind="EditingHour" class="wheel-select @(ShowTimeError && !EditingHour.HasValue ? "wheel-select-error" : "")">
                                <option value="">--</option>
                                <option value="12">12</option>
                                @for (int h = 1; h <= 11; h++)
                                {
                                    <option value="@h">@h</option>
                                }
                            </select>
                        </div>
                        <div class="time-picker-wheel">
                            <select @bind="EditingMinute" class="wheel-select @(ShowTimeError && !EditingMinute.HasValue ? "wheel-select-error" : "")">
                                <option value="">--</option>
                                <option value="0">00</option>
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="45">45</option>
                            </select>
                        </div>
                        <div class="time-picker-wheel">
                            <select @bind="EditingAmPm" class="wheel-select @(ShowTimeError && string.IsNullOrEmpty(EditingAmPm) ? "wheel-select-error" : "")">
                                <option value="">--</option>
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                            </select>
                        </div>
                    </div>
                    @if (ShowTimeError)
                    {
                        <span class="time-error-message">Please select hour, minute, and AM/PM</span>
                    }
                </div>

                <div class="form-group">
                    <label>Type</label>
                    <div class="type-selector">
                        @foreach (EventType type in Enum.GetValues<EventType>())
                        {
                            <button class="type-btn @(EditingEvent.Type == type ? "selected" : "")"
                                    style="--type-color: @type.GetColor()"
                                    @onclick="() => EditingEvent.Type = type">
                                @type.GetDisplayName()
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                @if (IsEditing)
                {
                    <button class="delete-btn" @onclick="ShowDeleteConfirmation" disabled="@(!_isOnline)">Delete</button>
                }
                <button class="cancel-btn" @onclick="CloseModal">Cancel</button>
                <button class="save-btn" @onclick="SaveEvent" disabled="@(string.IsNullOrWhiteSpace(EditingEvent.Title) || !_isOnline)">
                    @(IsEditing ? "Save" : "Add Event")
                </button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (ShowDeleteModal)
{
    <div class="modal-overlay" @onclick="CancelDelete">
        <div class="modal-content confirm-modal" @onclick:stopPropagation="true">
            <div class="confirm-icon delete-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </div>
            <h3 class="confirm-title">Delete this event?</h3>
            <p class="confirm-text">This can't be undone.</p>
            <div class="confirm-actions">
                <button class="cancel-btn" @onclick="CancelDelete">Cancel</button>
                <button class="delete-confirm-btn" @onclick="ConfirmDelete" disabled="@(!_isOnline)">Delete</button>
            </div>
        </div>
    </div>
}

@code {
    private DateTime CurrentDate = DateTime.Today;
    private DateTime? SelectedDate;
    private List<CalendarDay> CalendarDays = new();
    private List<Event> MonthEvents = new();
    private List<Event> SelectedDayEvents = new();

    private bool _isLoading = true;
    private bool _isLoadingMonth;
    private bool _isOnline = true;

    private bool ShowEventModal;
    private bool ShowDeleteModal;
    private bool ShowTimeError;
    private bool IsEditing;
    private Event EditingEvent = new();
    private DateTime EditingEventDate;
    private int? EditingHour;
    private int? EditingMinute;
    private string? EditingAmPm;

    private static readonly string[] DayNames = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    protected override async Task OnInitializedAsync()
    {
        SelectedDate = DateTime.Today;
        try
        {
            Connectivity.ConnectivityChanged += OnConnectivityChanged;
            _isOnline = Connectivity.NetworkAccess == NetworkAccess.Internet;
            await LoadMonthData();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnConnectivityChanged(object? sender, ConnectivityChangedEventArgs e)
    {
        _isOnline = e.NetworkAccess == NetworkAccess.Internet;
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadMonthData()
    {
        MonthEvents = await ScheduleService.GetEventsByMonthAsync(CurrentDate.Year, CurrentDate.Month);
        BuildCalendarDays();

        if (SelectedDate.HasValue)
        {
            await LoadSelectedDayEvents();
        }
    }

    private void BuildCalendarDays()
    {
        CalendarDays.Clear();

        var firstOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        var startDate = firstOfMonth.AddDays(-(int)firstOfMonth.DayOfWeek);

        for (int i = 0; i < 42; i++)
        {
            var date = startDate.AddDays(i);
            var dayEvents = MonthEvents.Where(e => e.Date.Date == date.Date).ToList();

            CalendarDays.Add(new CalendarDay
            {
                Date = date,
                IsCurrentMonth = date.Month == CurrentDate.Month,
                IsToday = date.Date == DateTime.Today,
                Events = dayEvents
            });
        }
    }

    private async Task LoadSelectedDayEvents()
    {
        if (SelectedDate.HasValue)
        {
            SelectedDayEvents = await ScheduleService.GetEventsByDateAsync(SelectedDate.Value);
        }
    }

    private async Task SelectDay(DateTime date)
    {
        SelectedDate = date;

        if (date.Month != CurrentDate.Month)
        {
            CurrentDate = new DateTime(date.Year, date.Month, 1);
            await LoadMonthData();
        }
        else
        {
            await LoadSelectedDayEvents();
        }
    }

    private async Task PreviousMonth()
    {
        _isLoadingMonth = true;
        try
        {
            CurrentDate = CurrentDate.AddMonths(-1);
            await LoadMonthData();
        }
        finally
        {
            _isLoadingMonth = false;
        }
    }

    private async Task NextMonth()
    {
        _isLoadingMonth = true;
        try
        {
            CurrentDate = CurrentDate.AddMonths(1);
            await LoadMonthData();
        }
        finally
        {
            _isLoadingMonth = false;
        }
    }

    private void OpenAddEventModal()
    {
        IsEditing = false;
        EditingEvent = new Event
        {
            Type = EventType.Other,
            AllDay = true
        };
        // Use the selected date directly (it's already local time)
        EditingEventDate = SelectedDate ?? DateTime.Today;
        EditingHour = null;
        EditingMinute = null;
        EditingAmPm = null;
        ShowEventModal = true;
    }

    private void OpenEditEventModal(Event evt)
    {
        IsEditing = true;
        EditingEvent = new Event
        {
            Id = evt.Id,
            Title = evt.Title,
            StartsAt = evt.StartsAt,
            EndsAt = evt.EndsAt,
            AllDay = evt.AllDay,
            Type = evt.Type,
            Location = evt.Location,
            Notes = evt.Notes,
            CreatedAt = evt.CreatedAt
        };
        EditingEventDate = evt.Date;

        // Convert TimeSpan to hour/minute/ampm
        if (evt.Time.HasValue)
        {
            var time = evt.Time.Value;
            var hour24 = time.Hours;
            EditingAmPm = hour24 >= 12 ? "PM" : "AM";
            EditingHour = hour24 == 0 ? 12 : (hour24 > 12 ? hour24 - 12 : hour24);
            EditingMinute = time.Minutes;
        }
        else
        {
            EditingHour = null;
            EditingMinute = null;
            EditingAmPm = null;
        }
        ShowEventModal = true;
    }

    private void CloseModal()
    {
        ShowEventModal = false;
        EditingEvent = new Event();
    }

    private bool HasValidTime => EditingHour.HasValue && EditingMinute.HasValue && !string.IsNullOrEmpty(EditingAmPm);

    private bool HasPartialTime
    {
        get
        {
            var hasHour = EditingHour.HasValue;
            var hasMinute = EditingMinute.HasValue;
            var hasAmPm = !string.IsNullOrEmpty(EditingAmPm);
            var selectedCount = (hasHour ? 1 : 0) + (hasMinute ? 1 : 0) + (hasAmPm ? 1 : 0);
            // Partial if 1 or 2 values selected (not 0 and not all 3)
            return selectedCount > 0 && selectedCount < 3;
        }
    }

    private async Task SaveEvent()
    {
        if (string.IsNullOrWhiteSpace(EditingEvent.Title))
            return;

        Console.WriteLine($"[Calendar] SaveEvent - TimeZone: {TimeZoneInfo.Local.DisplayName}, Offset: {TimeZoneInfo.Local.BaseUtcOffset}");
        Console.WriteLine($"[Calendar] Inputs - Date: {EditingEventDate:yyyy-MM-dd} (Kind: {EditingEventDate.Kind}), Hour: {EditingHour}, Minute: {EditingMinute}, AmPm: {EditingAmPm}");

        // Set StartsAt based on date and optional time
        // Convert local time to UTC for storage
        // Must explicitly specify Kind=Local since input bindings return Unspecified
        if (HasValidTime)
        {
            // Convert 12-hour to 24-hour format
            var hour24 = EditingHour!.Value;
            if (EditingAmPm == "PM" && hour24 != 12) hour24 += 12;
            if (EditingAmPm == "AM" && hour24 == 12) hour24 = 0;

            var timeSpan = new TimeSpan(hour24, EditingMinute!.Value, 0);
            var dt = EditingEventDate.Date.Add(timeSpan);
            var localDateTime = DateTime.SpecifyKind(dt, DateTimeKind.Local);

            Console.WriteLine($"[Calendar] Combined Local: {localDateTime:O} (Kind: {localDateTime.Kind})");

            EditingEvent.StartsAt = localDateTime.ToUniversalTime();
            EditingEvent.AllDay = false;

            Console.WriteLine($"[Calendar] Converted UTC: {EditingEvent.StartsAt:O} (Kind: {EditingEvent.StartsAt.Kind})");
        }
        else
        {
            // For all-day events, store as start of day in UTC
            var localDate = DateTime.SpecifyKind(EditingEventDate.Date, DateTimeKind.Local);
            EditingEvent.StartsAt = localDate.ToUniversalTime();
            EditingEvent.AllDay = true;
            Console.WriteLine($"[Calendar] AllDay UTC: {EditingEvent.StartsAt:O} (Kind: {EditingEvent.StartsAt.Kind})");
        }

        await ScheduleService.SaveEventAsync(EditingEvent);
        CloseModal();

        if (EditingEventDate.Month != CurrentDate.Month || EditingEventDate.Year != CurrentDate.Year)
        {
            CurrentDate = new DateTime(EditingEventDate.Year, EditingEventDate.Month, 1);
            SelectedDate = EditingEventDate;
        }

        await LoadMonthData();
    }

    private void ShowDeleteConfirmation()
    {
        ShowEventModal = false;
        ShowDeleteModal = true;
    }

    private void CancelDelete()
    {
        ShowDeleteModal = false;
        ShowEventModal = true;
    }

    private async Task ConfirmDelete()
    {
        await ScheduleService.DeleteEventAsync(EditingEvent.Id);
        ShowDeleteModal = false;
        CloseModal();
        await LoadMonthData();
    }

    private string FormatTime(TimeSpan time)
    {
        var dt = DateTime.Today.Add(time);
        return dt.ToString("h:mm tt");
    }

    public void Dispose()
    {
        Connectivity.ConnectivityChanged -= OnConnectivityChanged;
    }

    private class CalendarDay
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool IsToday { get; set; }
        public List<Event> Events { get; set; } = new();
    }
}
