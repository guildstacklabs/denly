@page "/costs"
@using Denly.Models
@using Denly.Services
@inject IExpenseService ExpenseService

<div class="expenses-page">
    <!-- Header with Balance -->
    <div class="page-header">
        <h1>Shared Costs</h1>
        <button class="add-btn" @onclick="OpenAddExpenseModal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add
        </button>
    </div>

    <!-- Balance Card -->
    <div class="balance-card">
        <div class="balance-label">Current Balance</div>
        @if (Balance == 0)
        {
            <div class="balance-amount settled">All settled up</div>
        }
        else if (Balance > 0)
        {
            <div class="balance-amount owes">
                Parent A owes Parent B <span class="amount">@Balance.ToString("C")</span>
            </div>
        }
        else
        {
            <div class="balance-amount owes">
                Parent B owes Parent A <span class="amount">@Math.Abs(Balance).ToString("C")</span>
            </div>
        }
        <div class="balance-note">Based on 50/50 split</div>
        @if (Balance != 0)
        {
            <button class="settle-up-btn" @onclick="OpenSettleUpModal">Settle Up</button>
        }
    </div>

    <!-- Expenses & Settlements List -->
    <div class="expenses-section">
        <h2>History</h2>

        @if (_allEntries.Any())
        {
            <div class="expenses-list">
                @foreach (var entry in _allEntries)
                {
                    @if (entry.Settlement != null)
                    {
                        <div class="settlement-card">
                            <div class="settlement-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 12l2 2 4-4"></path>
                                    <circle cx="12" cy="12" r="10"></circle>
                                </svg>
                            </div>
                            <div class="settlement-content">
                                <div class="settlement-header">
                                    <div class="settlement-description">Settlement</div>
                                    <div class="settlement-amount">@entry.Settlement.Amount.ToString("C")</div>
                                </div>
                                <div class="settlement-meta">
                                    <span class="settlement-detail">@entry.Settlement.FromParent.GetDisplayName() paid @entry.Settlement.ToParent.GetDisplayName()</span>
                                    <span class="settlement-date">@entry.Settlement.Date.ToString("MMM d")</span>
                                </div>
                            </div>
                        </div>
                    }
                    else if (entry.Expense != null)
                    {
                        <div class="expense-card @(entry.Expense.SettlementId != null ? "settled" : "")" @onclick="() => OpenEditExpenseModal(entry.Expense)">
                            <div class="expense-color-bar" style="background-color: @entry.Expense.Category.GetColor()"></div>
                            <div class="expense-content">
                                <div class="expense-header">
                                    <div class="expense-description">
                                        @entry.Expense.Description
                                        @if (entry.Expense.SettlementId != null)
                                        {
                                            <span class="settled-badge">Settled</span>
                                        }
                                    </div>
                                    <div class="expense-amount">@entry.Expense.Amount.ToString("C")</div>
                                </div>
                                <div class="expense-meta">
                                    <span class="expense-category">@entry.Expense.Category.GetDisplayName()</span>
                                    <span class="expense-date">@entry.Expense.Date.ToString("MMM d")</span>
                                    <span class="expense-payer">@entry.Expense.PaidBy.GetDisplayName()</span>
                                    @if (!string.IsNullOrEmpty(entry.Expense.ReceiptPath))
                                    {
                                        <span class="receipt-indicator">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                <polyline points="21 15 16 10 5 21"></polyline>
                                            </svg>
                                        </span>
                                    }
                                </div>
                            </div>
                            <svg class="expense-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    }
                }
            </div>
        }
        else
        {
            <div class="no-expenses">
                <p>No shared expenses yet</p>
                <span class="empty-hint">Start tracking costs together</span>
                <button class="add-expense-link" @onclick="OpenAddExpenseModal">Add your first expense</button>
            </div>
        }
    </div>
</div>

<!-- Expense Modal -->
@if (ShowExpenseModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(IsEditing ? "Edit Expense" : "New Expense")</h3>
                <button class="close-btn" @onclick="CloseModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" @bind="EditingExpense.Description" placeholder="What was this for?" />
                </div>

                <div class="form-group">
                    <label>Amount</label>
                    <div class="amount-input-wrapper">
                        <span class="currency-symbol">$</span>
                        <input type="number" step="0.01" min="0" inputmode="decimal" @bind="EditingAmount" placeholder="0.00" />
                    </div>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" @bind="EditingExpenseDate" />
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <div class="type-selector">
                        @foreach (ExpenseCategory category in Enum.GetValues<ExpenseCategory>())
                        {
                            <button class="type-btn @(EditingExpense.Category == category ? "selected" : "")"
                                    style="--type-color: @category.GetColor()"
                                    @onclick="() => EditingExpense.Category = category">
                                @category.GetDisplayName()
                            </button>
                        }
                    </div>
                </div>

                <div class="form-group">
                    <label>Who paid?</label>
                    <div class="payer-selector">
                        @foreach (Parent parent in Enum.GetValues<Parent>())
                        {
                            <button class="payer-btn @(EditingExpense.PaidBy == parent ? "selected" : "")"
                                    @onclick="() => EditingExpense.PaidBy = parent">
                                @parent.GetDisplayName()
                            </button>
                        }
                    </div>
                </div>

                <div class="form-group">
                    <label>Receipt (optional)</label>
                    <div class="receipt-section">
                        @if (!string.IsNullOrEmpty(EditingExpense.ReceiptPath))
                        {
                            <div class="receipt-preview">
                                <img src="@EditingExpense.ReceiptPath" alt="Receipt" />
                                <button class="remove-receipt-btn" @onclick="RemoveReceipt" type="button">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="receipt-buttons">
                                <button class="receipt-btn" @onclick="TakePhoto" type="button">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                        <circle cx="12" cy="13" r="4"></circle>
                                    </svg>
                                    Camera
                                </button>
                                <button class="receipt-btn" @onclick="PickFromGallery" type="button">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    Gallery
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                @if (IsEditing)
                {
                    <button class="delete-btn" @onclick="ShowDeleteConfirmation">Delete</button>
                }
                <button class="cancel-btn" @onclick="CloseModal">Cancel</button>
                <button class="save-btn" @onclick="SaveExpense" disabled="@(!IsValidExpense)">
                    @(IsEditing ? "Save" : "Add Expense")
                </button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (ShowDeleteModal)
{
    <div class="modal-overlay" @onclick="CancelDelete">
        <div class="modal-content confirm-modal" @onclick:stopPropagation="true">
            <div class="confirm-icon delete-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </div>
            <h3 class="confirm-title">Delete this expense?</h3>
            <p class="confirm-text">This can't be undone.</p>
            <div class="confirm-actions">
                <button class="cancel-btn" @onclick="CancelDelete">Cancel</button>
                <button class="delete-confirm-btn" @onclick="ConfirmDelete">Delete</button>
            </div>
        </div>
    </div>
}

<!-- Settle Up Modal -->
@if (ShowSettleUpModal)
{
    <div class="modal-overlay" @onclick="CloseSettleUpModal">
        <div class="modal-content settle-up-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Settle Up</h3>
                <button class="close-btn" @onclick="CloseSettleUpModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="settle-up-summary">
                    <div class="settle-up-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </div>
                    @if (Balance > 0)
                    {
                        <div class="settle-up-text">
                            <strong>@Parent.ParentA.GetDisplayName()</strong> owes
                            <strong>@Parent.ParentB.GetDisplayName()</strong>
                        </div>
                        <div class="settle-up-amount">@Balance.ToString("C")</div>
                    }
                    else
                    {
                        <div class="settle-up-text">
                            <strong>@Parent.ParentB.GetDisplayName()</strong> owes
                            <strong>@Parent.ParentA.GetDisplayName()</strong>
                        </div>
                        <div class="settle-up-amount">@Math.Abs(Balance).ToString("C")</div>
                    }
                    <div class="settle-up-note">
                        This will mark all current expenses as settled.
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="cancel-btn" @onclick="CloseSettleUpModal">Cancel</button>
                <button class="save-btn" @onclick="ConfirmSettlement">Confirm Settlement</button>
            </div>
        </div>
    </div>
}

@code {
    private List<Expense> _expenses = new();
    private List<Settlement> _settlements = new();
    private List<HistoryEntry> _allEntries = new();
    private decimal Balance;

    private bool ShowExpenseModal;
    private bool ShowSettleUpModal;
    private bool ShowDeleteModal;
    private bool IsEditing;
    private Expense EditingExpense = new();
    private DateTime EditingExpenseDate;
    private decimal? EditingAmount;

    private bool IsValidExpense => !string.IsNullOrWhiteSpace(EditingExpense.Description) && EditingAmount.HasValue && EditingAmount.Value > 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _expenses = await ExpenseService.GetAllExpensesAsync();
        _settlements = await ExpenseService.GetAllSettlementsAsync();
        Balance = await ExpenseService.GetBalanceAsync();

        // Combine expenses and settlements into a unified list sorted by date
        _allEntries = new List<HistoryEntry>();
        foreach (var expense in _expenses)
        {
            _allEntries.Add(new HistoryEntry { Expense = expense, SortDate = expense.Date, SortCreatedAt = expense.CreatedAt });
        }
        foreach (var settlement in _settlements)
        {
            _allEntries.Add(new HistoryEntry { Settlement = settlement, SortDate = settlement.Date, SortCreatedAt = settlement.CreatedAt });
        }
        _allEntries = _allEntries.OrderByDescending(e => e.SortDate).ThenByDescending(e => e.SortCreatedAt).ToList();
    }

    private void OpenAddExpenseModal()
    {
        IsEditing = false;
        EditingExpense = new Expense
        {
            Date = DateTime.Today,
            Category = ExpenseCategory.Other,
            PaidBy = Parent.ParentA
        };
        EditingExpenseDate = EditingExpense.Date;
        EditingAmount = null;
        ShowExpenseModal = true;
    }

    private void OpenEditExpenseModal(Expense expense)
    {
        IsEditing = true;
        EditingExpense = new Expense
        {
            Id = expense.Id,
            Description = expense.Description,
            Amount = expense.Amount,
            Date = expense.Date,
            Category = expense.Category,
            PaidBy = expense.PaidBy,
            ReceiptPath = expense.ReceiptPath,
            SettlementId = expense.SettlementId,
            CreatedAt = expense.CreatedAt
        };
        EditingExpenseDate = expense.Date;
        EditingAmount = expense.Amount;
        ShowExpenseModal = true;
    }

    private void CloseModal()
    {
        ShowExpenseModal = false;
        EditingExpense = new();
    }

    private async Task SaveExpense()
    {
        if (!IsValidExpense)
            return;

        EditingExpense.Date = EditingExpenseDate;
        EditingExpense.Amount = EditingAmount!.Value;

        await ExpenseService.SaveExpenseAsync(EditingExpense);
        CloseModal();
        await LoadData();
    }

    private void ShowDeleteConfirmation()
    {
        ShowExpenseModal = false;
        ShowDeleteModal = true;
    }

    private void CancelDelete()
    {
        ShowDeleteModal = false;
        ShowExpenseModal = true;
    }

    private async Task ConfirmDelete()
    {
        if (!string.IsNullOrEmpty(EditingExpense.ReceiptPath))
        {
            await ExpenseService.DeleteReceiptAsync(EditingExpense.ReceiptPath);
        }
        await ExpenseService.DeleteExpenseAsync(EditingExpense.Id);
        ShowDeleteModal = false;
        CloseModal();
        await LoadData();
    }

    private async Task TakePhoto()
    {
        try
        {
            if (!MediaPicker.Default.IsCaptureSupported)
                return;

            var photo = await MediaPicker.Default.CapturePhotoAsync();
            if (photo != null)
            {
                await SaveReceiptFromFile(photo);
            }
        }
        catch
        {
            // Handle gracefully - camera not available
        }
    }

    private async Task PickFromGallery()
    {
        try
        {
            var photo = await MediaPicker.Default.PickPhotoAsync();
            if (photo != null)
            {
                await SaveReceiptFromFile(photo);
            }
        }
        catch
        {
            // Handle gracefully - gallery not available
        }
    }

    private async Task SaveReceiptFromFile(FileResult photo)
    {
        using var stream = await photo.OpenReadAsync();
        var receiptPath = await ExpenseService.SaveReceiptAsync(stream, photo.FileName);
        EditingExpense.ReceiptPath = receiptPath;
        StateHasChanged();
    }

    private async Task RemoveReceipt()
    {
        if (!string.IsNullOrEmpty(EditingExpense.ReceiptPath))
        {
            await ExpenseService.DeleteReceiptAsync(EditingExpense.ReceiptPath);
            EditingExpense.ReceiptPath = null;
            StateHasChanged();
        }
    }

    private void OpenSettleUpModal()
    {
        ShowSettleUpModal = true;
    }

    private void CloseSettleUpModal()
    {
        ShowSettleUpModal = false;
    }

    private async Task ConfirmSettlement()
    {
        var amount = Math.Abs(Balance);
        var fromParent = Balance > 0 ? Parent.ParentA : Parent.ParentB;
        var toParent = Balance > 0 ? Parent.ParentB : Parent.ParentA;

        await ExpenseService.CreateSettlementAsync(amount, fromParent, toParent);
        CloseSettleUpModal();
        await LoadData();
    }

    private class HistoryEntry
    {
        public Expense? Expense { get; set; }
        public Settlement? Settlement { get; set; }
        public DateTime SortDate { get; set; }
        public DateTime SortCreatedAt { get; set; }
    }
}
