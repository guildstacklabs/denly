@page "/costs"
@using Denly.Models
@using Denly.Services
@inject IExpenseService ExpenseService

<div class="expenses-page">
    <!-- Header with Balance -->
    <div class="page-header">
        <h1>Shared Costs</h1>
        <button class="add-btn" @onclick="OpenAddExpenseModal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add
        </button>
    </div>

    <!-- Balance Card -->
    <div class="balance-card">
        <div class="balance-label">Current Balance</div>
        @if (Balance == 0)
        {
            <div class="balance-amount settled">All settled up</div>
        }
        else if (Balance > 0)
        {
            <div class="balance-amount owes">
                Parent A owes Parent B <span class="amount">@Balance.ToString("C")</span>
            </div>
        }
        else
        {
            <div class="balance-amount owes">
                Parent B owes Parent A <span class="amount">@Math.Abs(Balance).ToString("C")</span>
            </div>
        }
        <div class="balance-note">Based on 50/50 split</div>
    </div>

    <!-- Expenses List -->
    <div class="expenses-section">
        <h2>Expenses</h2>

        @if (_expenses.Any())
        {
            <div class="expenses-list">
                @foreach (var expense in _expenses)
                {
                    <div class="expense-card" @onclick="() => OpenEditExpenseModal(expense)">
                        <div class="expense-color-bar" style="background-color: @expense.Category.GetColor()"></div>
                        <div class="expense-content">
                            <div class="expense-header">
                                <div class="expense-description">@expense.Description</div>
                                <div class="expense-amount">@expense.Amount.ToString("C")</div>
                            </div>
                            <div class="expense-meta">
                                <span class="expense-category">@expense.Category.GetDisplayName()</span>
                                <span class="expense-date">@expense.Date.ToString("MMM d")</span>
                                <span class="expense-payer">@expense.PaidBy.GetDisplayName()</span>
                            </div>
                        </div>
                        <svg class="expense-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="no-expenses">
                <p>No expenses recorded yet</p>
                <button class="add-expense-link" @onclick="OpenAddExpenseModal">Add your first expense</button>
            </div>
        }
    </div>
</div>

<!-- Expense Modal -->
@if (ShowExpenseModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(IsEditing ? "Edit Expense" : "New Expense")</h3>
                <button class="close-btn" @onclick="CloseModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" @bind="EditingExpense.Description" placeholder="What was this for?" />
                </div>

                <div class="form-group">
                    <label>Amount</label>
                    <div class="amount-input-wrapper">
                        <span class="currency-symbol">$</span>
                        <input type="number" step="0.01" min="0" @bind="EditingAmount" placeholder="0.00" />
                    </div>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" @bind="EditingExpenseDate" />
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <div class="type-selector">
                        @foreach (ExpenseCategory category in Enum.GetValues<ExpenseCategory>())
                        {
                            <button class="type-btn @(EditingExpense.Category == category ? "selected" : "")"
                                    style="--type-color: @category.GetColor()"
                                    @onclick="() => EditingExpense.Category = category">
                                @category.GetDisplayName()
                            </button>
                        }
                    </div>
                </div>

                <div class="form-group">
                    <label>Who paid?</label>
                    <div class="payer-selector">
                        @foreach (Parent parent in Enum.GetValues<Parent>())
                        {
                            <button class="payer-btn @(EditingExpense.PaidBy == parent ? "selected" : "")"
                                    @onclick="() => EditingExpense.PaidBy = parent">
                                @parent.GetDisplayName()
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                @if (IsEditing)
                {
                    <button class="delete-btn" @onclick="DeleteExpense">Delete</button>
                }
                <button class="cancel-btn" @onclick="CloseModal">Cancel</button>
                <button class="save-btn" @onclick="SaveExpense" disabled="@(!IsValidExpense)">
                    @(IsEditing ? "Save" : "Add Expense")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<Expense> _expenses = new();
    private decimal Balance;

    private bool ShowExpenseModal;
    private bool IsEditing;
    private Expense EditingExpense = new();
    private DateTime EditingExpenseDate;
    private decimal EditingAmount;

    private bool IsValidExpense => !string.IsNullOrWhiteSpace(EditingExpense.Description) && EditingAmount > 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _expenses = await ExpenseService.GetAllExpensesAsync();
        Balance = await ExpenseService.GetBalanceAsync();
    }

    private void OpenAddExpenseModal()
    {
        IsEditing = false;
        EditingExpense = new Expense
        {
            Date = DateTime.Today,
            Category = ExpenseCategory.Other,
            PaidBy = Parent.ParentA
        };
        EditingExpenseDate = EditingExpense.Date;
        EditingAmount = 0;
        ShowExpenseModal = true;
    }

    private void OpenEditExpenseModal(Expense expense)
    {
        IsEditing = true;
        EditingExpense = new Expense
        {
            Id = expense.Id,
            Description = expense.Description,
            Amount = expense.Amount,
            Date = expense.Date,
            Category = expense.Category,
            PaidBy = expense.PaidBy,
            CreatedAt = expense.CreatedAt
        };
        EditingExpenseDate = expense.Date;
        EditingAmount = expense.Amount;
        ShowExpenseModal = true;
    }

    private void CloseModal()
    {
        ShowExpenseModal = false;
        EditingExpense = new();
    }

    private async Task SaveExpense()
    {
        if (!IsValidExpense)
            return;

        EditingExpense.Date = EditingExpenseDate;
        EditingExpense.Amount = EditingAmount;

        await ExpenseService.SaveExpenseAsync(EditingExpense);
        CloseModal();
        await LoadData();
    }

    private async Task DeleteExpense()
    {
        await ExpenseService.DeleteExpenseAsync(EditingExpense.Id);
        CloseModal();
        await LoadData();
    }
}
