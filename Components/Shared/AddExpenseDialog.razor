@using System.ComponentModel.DataAnnotations
@using Denly.Components.Shared

@if (IsOpen)
{
    <div class="modal-overlay" @onclick="OnCancel">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(IsEditing ? "Edit item" : "New item")</h3>
                <button class="close-btn" @onclick="OnCancel" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <EditForm Model="Model" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <div class="modal-body">
                    <div class="form-group">
                        <label>Date</label>
                        <InputDate @bind-Value="Model.Date" class="modal-input" />
                    </div>

                    <div class="form-group">
                        <label>Amount</label>
                        <InputNumber @bind-Value="Model.Amount" placeholder="0.00" class="modal-input" />
                    </div>

                    <div class="form-group">
                        <label>Added by</label>
                        <InputSelect @bind-Value="Model.PayerId" class="modal-input">
                            <option value="">Select a caregiver</option>
                            @foreach (var caregiver in Caregivers)
                            {
                                <option value="@caregiver.Id">@caregiver.Name</option>
                            }
                        </InputSelect>
                    </div>

                    @if (Children.Count > 0)
                    {
                        <div class="form-group">
                            <label>Children (optional)</label>
                            <div class="child-checkboxes">
                                @foreach (var child in Children)
                                {
                                    <label class="checkbox-label">
                                        <input type="checkbox"
                                               checked="@Model.ChildIds.Contains(child.Id)"
                                               @onchange="e => ToggleChild(child.Id, (bool)(e.Value ?? false))" />
                                        @child.Name
                                    </label>
                                }
                            </div>
                        </div>
                    }

                    @if (Caregivers.Count == 2)
                    {
                        <div class="form-group">
                            <label>Split</label>
                            <select class="modal-input" @onchange="OnSplitChanged" value="@_selectedSplit">
                                <option value="50-50">50/50 (even)</option>
                                <option value="60-40">60/40</option>
                                <option value="70-30">70/30</option>
                                <option value="80-20">80/20</option>
                            </select>
                            <div class="split-preview">
                                @if (Model.Splits.Count >= 2)
                                {
                                    <span>@Model.Splits[0].CaregiverName: @Model.Splits[0].Percent%</span>
                                    <span class="split-separator">â€¢</span>
                                    <span>@Model.Splits[1].CaregiverName: @Model.Splits[1].Percent%</span>
                                }
                            </div>
                        </div>
                    }

                    <ValidationSummary />
                </div>

                <div class="modal-footer">
                    @if (IsEditing)
                    {
                        <button type="button" class="delete-btn" @onclick="OnDelete">Remove</button>
                    }
                    <button type="button" class="cancel-btn" @onclick="OnCancel">Cancel</button>
                    <button type="submit" class="save-btn">Save item</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public bool IsEditing { get; set; }
    [Parameter] public AddExpenseInput Model { get; set; } = new();
    [Parameter] public IReadOnlyList<CaregiverOption> Caregivers { get; set; } = Array.Empty<CaregiverOption>();
    [Parameter] public IReadOnlyList<ChildOption> Children { get; set; } = Array.Empty<ChildOption>();
    [Parameter] public string? CurrentUserId { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<AddExpenseInput> OnSave { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }

    private string _selectedSplit = "50-50";

    protected override void OnParametersSet()
    {
        if (Caregivers.Count == 0) return;

        // Initialize splits if empty or reset for new expense
        if (Model.Splits.Count == 0 || Model.Id == null)
        {
            _selectedSplit = "50-50";
            ApplySplit(50, 50);
        }
        else if (Model.Splits.Count >= 2)
        {
            // Detect current split from existing data
            var p1 = Model.Splits[0].Percent;
            var p2 = Model.Splits[1].Percent;
            _selectedSplit = (p1, p2) switch
            {
                (50, 50) => "50-50",
                (60, 40) => "60-40",
                (70, 30) => "70-30",
                (80, 20) => "80-20",
                (40, 60) => "60-40",
                (30, 70) => "70-30",
                (20, 80) => "80-20",
                _ => "50-50"
            };
        }

        if (string.IsNullOrWhiteSpace(Model.PayerId))
        {
            var preferred = !string.IsNullOrWhiteSpace(CurrentUserId)
                && Caregivers.Any(c => c.Id == CurrentUserId)
                ? CurrentUserId
                : Caregivers.FirstOrDefault()?.Id;
            Model.PayerId = preferred ?? string.Empty;
        }
    }

    private void OnSplitChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "50-50";
        _selectedSplit = value;

        var (p1, p2) = value switch
        {
            "60-40" => (60m, 40m),
            "70-30" => (70m, 30m),
            "80-20" => (80m, 20m),
            _ => (50m, 50m)
        };

        ApplySplit(p1, p2);
    }

    private void ApplySplit(decimal percent1, decimal percent2)
    {
        if (Caregivers.Count < 2) return;

        Model.Splits = new List<SplitInput>
        {
            new SplitInput
            {
                CaregiverId = Caregivers[0].Id,
                CaregiverName = Caregivers[0].Name,
                Percent = percent1
            },
            new SplitInput
            {
                CaregiverId = Caregivers[1].Id,
                CaregiverName = Caregivers[1].Name,
                Percent = percent2
            }
        };
    }

    private void ToggleChild(string childId, bool isChecked)
    {
        if (isChecked && !Model.ChildIds.Contains(childId))
            Model.ChildIds.Add(childId);
        else if (!isChecked)
            Model.ChildIds.Remove(childId);
    }

    private async Task HandleValidSubmit()
    {
        await OnSave.InvokeAsync(Model);
    }

    public class AddExpenseInput : IValidatableObject
    {
        public string? Id { get; set; } // For editing

        [Required]
        public DateTime Date { get; set; } = DateTime.Today;

        public string Description { get; set; } = string.Empty;

        [Range(0.01, 100000)]
        public decimal Amount { get; set; }

        [Required]
        public string PayerId { get; set; } = string.Empty;

        public List<SplitInput> Splits { get; set; } = new();

        public List<string> ChildIds { get; set; } = new();

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            // Simple validation: check if sum is roughly 100% ONLY if splits are used/modified.
            // For now, we trust the user or default logic.
            // Implementing robust split validation is complex (auto-balancing vs manual).
            // We'll skip strict 100% check to avoid blocking simple entry, unless we add UI to manage it.
            // But let's check basic validity.
            yield break;
        }
    }

    public class SplitInput
    {
        public string CaregiverId { get; set; } = string.Empty;
        public string CaregiverName { get; set; } = string.Empty;
        public decimal Percent { get; set; }
    }
}
