@using System.ComponentModel.DataAnnotations
@using Denly.Components.Shared

@if (IsOpen)
{
    <div class="modal-overlay" @onclick="OnCancel">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(IsEditing ? "Edit item" : "New item")</h3>
                <button class="close-btn" @onclick="OnCancel" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <EditForm Model="Model" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <div class="modal-body">
                    <div class="form-group">
                        <label>Date</label>
                        <InputDate @bind-Value="Model.Date" class="modal-input" />
                    </div>

                    <div class="form-group">
                        <label>Amount</label>
                        <InputNumber @bind-Value="Model.Amount" placeholder="0.00" class="modal-input" />
                    </div>

                    <div class="form-group">
                        <label>Added by</label>
                        <InputSelect @bind-Value="Model.PayerId" class="modal-input">
                            <option value="">Select a caregiver</option>
                            @foreach (var caregiver in Caregivers)
                            {
                                <option value="@caregiver.Id">@caregiver.Name</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="form-group">
                        <label>Child association (optional)</label>
                        <InputSelect @bind-Value="Model.ChildId" class="modal-input">
                            <option value="">None</option>
                            @foreach (var child in Children)
                            {
                                <option value="@child.Id">@child.Name</option>
                            }
                        </InputSelect>
                    </div>

                    <ValidationSummary />
                </div>

                <div class="modal-footer">
                    @if (IsEditing)
                    {
                        <button type="button" class="delete-btn" @onclick="OnDelete">Remove</button>
                    }
                    <button type="button" class="cancel-btn" @onclick="OnCancel">Cancel</button>
                    <button type="submit" class="save-btn">Save item</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public bool IsEditing { get; set; }
    [Parameter] public AddExpenseInput Model { get; set; } = new();
    [Parameter] public IReadOnlyList<CaregiverOption> Caregivers { get; set; } = Array.Empty<CaregiverOption>();
    [Parameter] public IReadOnlyList<ChildOption> Children { get; set; } = Array.Empty<ChildOption>();
    [Parameter] public string? CurrentUserId { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<AddExpenseInput> OnSave { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }

    protected override void OnParametersSet()
    {
        if (Caregivers.Count == 0) return;

        var updated = new List<SplitInput>();
        var even = Caregivers.Count > 0 ? Math.Round(100m / Caregivers.Count, 2) : 100m;

        foreach (var caregiver in Caregivers)
        {
            updated.Add(new SplitInput
            {
                CaregiverId = caregiver.Id,
                CaregiverName = caregiver.Name,
                Percent = even
            });
        }

        Model.Splits = updated;

        if (string.IsNullOrWhiteSpace(Model.PayerId))
        {
            var preferred = !string.IsNullOrWhiteSpace(CurrentUserId)
                && Caregivers.Any(c => c.Id == CurrentUserId)
                ? CurrentUserId
                : Caregivers.FirstOrDefault()?.Id;
            Model.PayerId = preferred ?? string.Empty;
        }
    }

    private async Task HandleValidSubmit()
    {
        await OnSave.InvokeAsync(Model);
    }

    public class AddExpenseInput : IValidatableObject
    {
        public string? Id { get; set; } // For editing

        [Required]
        public DateTime Date { get; set; } = DateTime.Today;

        public string Description { get; set; } = string.Empty;

        [Range(0.01, 100000)]
        public decimal Amount { get; set; }

        [Required]
        public string PayerId { get; set; } = string.Empty;

        public List<SplitInput> Splits { get; set; } = new();

        public string? ChildId { get; set; }

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            // Simple validation: check if sum is roughly 100% ONLY if splits are used/modified.
            // For now, we trust the user or default logic.
            // Implementing robust split validation is complex (auto-balancing vs manual).
            // We'll skip strict 100% check to avoid blocking simple entry, unless we add UI to manage it.
            // But let's check basic validity.
            yield break;
        }
    }

    public class SplitInput
    {
        public string CaregiverId { get; set; } = string.Empty;
        public string CaregiverName { get; set; } = string.Empty;
        public decimal Percent { get; set; }
    }
}
