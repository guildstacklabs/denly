@using System.ComponentModel.DataAnnotations
@using System.Globalization

@if (IsOpen)
{
    <div class="dialog-backdrop">
        <div class="dialog-card" style="@CardStyle">
            <h2 class="dialog-title" style="@TitleStyle">Settle up</h2>
            <div class="dialog-balance" style="@BalanceStyle">
                Current balance: @Balance.ToString("C", CultureInfo.CurrentCulture)
            </div>

            <EditForm Model="Model" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />

                <div class="dialog-field">
                    <label>Settlement amount</label>
                    <InputNumber @bind-Value="Model.Amount" />
                </div>

                <div class="dialog-field">
                    <label>Payer</label>
                    <InputSelect @bind-Value="Model.PayerId">
                        <option value="">Select a caregiver</option>
                        @foreach (var caregiver in Caregivers)
                        {
                            <option value="@caregiver.Id">@caregiver.Name</option>
                        }
                    </InputSelect>
                </div>

                <div class="dialog-field">
                    <label>Receiver</label>
                    <InputSelect @bind-Value="Model.ReceiverId">
                        <option value="">Select a caregiver</option>
                        @foreach (var caregiver in Caregivers)
                        {
                            <option value="@caregiver.Id">@caregiver.Name</option>
                        }
                    </InputSelect>
                </div>

                <ValidationSummary />

                <div class="dialog-actions">
                    <button type="button" class="dialog-btn secondary" @onclick="OnCancel">Cancel</button>
                    <button type="submit" class="dialog-btn primary">Save</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public decimal Balance { get; set; }
    [Parameter] public SettleUpInput Model { get; set; } = new();
    [Parameter] public IReadOnlyList<CaregiverOption> Caregivers { get; set; } = Array.Empty<CaregiverOption>();
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<SettleUpInput> OnSave { get; set; }

    private string CardStyle =>
        $"background:{DesignTokens.CssRgba(DesignTokens.Colors.NookBackground)};" +
        $"border-radius:{DesignTokens.Dimensions.RadiusNook}px;" +
        $"padding:{DesignTokens.Spacing.Xxl}px;" +
        $"box-shadow:{DesignTokens.Shadows.Nook};";

    private string TitleStyle =>
        $"font-family:{DesignTokens.Typography.FontHeading};" +
        $"font-size:{DesignTokens.Typography.SizeXl}px;" +
        $"margin-bottom:{DesignTokens.Spacing.Sm}px;";

    private string BalanceStyle =>
        $"font-size:{DesignTokens.Typography.SizeSm}px;" +
        $"opacity:{DesignTokens.Opacity.Soft};" +
        $"margin-bottom:{DesignTokens.Spacing.Md}px;";

    private async Task HandleValidSubmit()
    {
        await OnSave.InvokeAsync(Model);
    }

    public class SettleUpInput
    {
        [Range(0.01, 100000)]
        public decimal Amount { get; set; }

        [Required]
        public string PayerId { get; set; } = string.Empty;

        [Required]
        public string ReceiverId { get; set; } = string.Empty;
    }


}
