<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:shared="clr-namespace:Denly.Components.Shared"
             xmlns:viewmodels="clr-namespace:Denly.ViewModels"
             xmlns:local="clr-namespace:Denly.Pages"
             x:Class="Denly.Pages.CalendarMonthPage"
             Title="Month">
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:IntToBoolConverter x:Key="IntToBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <!-- Month grid view with markers and overflow indicator -->
    <VerticalStackLayout Padding="{x:Static shared:DesignTokens+Spacing.Xl}" Spacing="12">
        <Label Text="Month"
               FontSize="{x:Static shared:DesignTokens+Typography.SizeXl}"
               TextColor="{x:Static shared:DesignTokens+Colors.DenShadow}" />
        <HorizontalStackLayout Spacing="6" IsVisible="{Binding HasUpdates}">
            <shared:UpdatedMark />
            <Label Text="Updated"
                   FontSize="{x:Static shared:DesignTokens+Typography.SizeSm}"
                   TextColor="{x:Static shared:DesignTokens+Colors.DenShadow}" />
        </HorizontalStackLayout>
        <HorizontalStackLayout Spacing="8">
            <Label Text="Filter by child"
                   FontSize="{x:Static shared:DesignTokens+Typography.SizeSm}"
                   TextColor="{x:Static shared:DesignTokens+Colors.DenShadow}" />
            <Frame WidthRequest="8"
                   HeightRequest="8"
                   CornerRadius="4"
                   BackgroundColor="{x:Static shared:DesignTokens+Colors.Gold}"
                   IsVisible="{Binding IsFilterActive}"
                   HasShadow="False" />
        </HorizontalStackLayout>
        <CollectionView ItemsSource="{Binding ChildFilters}" ItemsLayout="HorizontalList">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="viewmodels:ChildFilterItem">
                    <shared:DenChip Text="{Binding Name}"
                                    ChipColor="{Binding ChipColor}">
                        <shared:DenChip.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding BindingContext.ToggleChildFilterCommand, Source={RelativeSource AncestorType=ContentPage}}"
                                                  CommandParameter="{Binding ChildId}" />
                        </shared:DenChip.GestureRecognizers>
                    </shared:DenChip>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
        <CollectionView ItemsSource="{Binding Days}" SelectionMode="Single" SelectionChanged="OnDaySelected">
            <CollectionView.ItemsLayout>
                <GridItemsLayout Orientation="Vertical" Span="7" />
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="viewmodels:CalendarDayViewModel">
                    <Grid Padding="6" ColumnDefinitions="*,Auto">
                        <Label Text="{Binding Date.Day}"
                               FontSize="{x:Static shared:DesignTokens+Typography.SizeSm}"
                               TextColor="{x:Static shared:DesignTokens+Colors.DenShadow}" />
                        <shared:UpdatedMark Grid.Column="1"
                                            HorizontalOptions="End"
                                            IsVisible="{Binding HasUpdates}" />
                        <HorizontalStackLayout Margin="0,18,0,0" Spacing="3">
                            <HorizontalStackLayout BindableLayout.ItemsSource="{Binding MarkerColors}" Spacing="3">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate>
                                        <BoxView WidthRequest="6" HeightRequest="6" Color="{Binding .}" />
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                            <Label Text="{Binding OverflowCount, StringFormat='+{0}'}"
                                   IsVisible="{Binding OverflowCount, Converter={StaticResource IntToBoolConverter}}"
                                   FontSize="{x:Static shared:DesignTokens+Typography.SizeXs}"
                                   TextColor="{x:Static shared:DesignTokens+Colors.DenShadow}" />
                        </HorizontalStackLayout>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </VerticalStackLayout>
</ContentPage>
